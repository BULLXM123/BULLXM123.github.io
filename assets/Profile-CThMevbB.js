import"./index-DyiAMGIZ.js";import{u as Q}from"./localTokenManager-DDQzZcWL.js";import{u as Y}from"./gameRoles-C_H-ZCPA.js";import{_ as X}from"./plugin-vueexport-helper-DlAUqK2U.js";import{u as Z,a as q,N as x,C as K,F as D,j as ee,I as te,B as oe}from"./ui-vendor-bYSxkbvo.js";import{E as ne}from"./EllipsisHorizontal-DSgZjaEv.js";import{R as J}from"./Refresh-DEl0-b7R.js";import{C as se}from"./CloudUpload-jfh8uwlP.js";import{S as le,T as re,C as ae}from"./TrashBin-C9UW3eMC.js";import{k as ie,S as P,U,V as o,X as ue,$ as s,Z as n,j as p,W as C,N as g,a2 as w,R as ce,F as de,m as _,r as pe,e as H,o as me,ag as ke}from"./vue-vendor-CjWJpnUV.js";import{u as fe}from"./auth-CeEVJIiN.js";import"./utils-C42QaX6I.js";const ve={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Te=o("rect",{x:"128",y:"128",width:"336",height:"336",rx:"57",ry:"57",fill:"none",stroke:"currentColor","stroke-linejoin":"round","stroke-width":"32"},null,-1),ge=o("path",{d:"M383.5 128l.5-24a56.16 56.16 0 0 0-56-56H112a64.19 64.19 0 0 0-64 64v216a56.16 56.16 0 0 0 56 56h24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),we=[Te,ge],_e=ie({name:"CopyOutline",render:function(a,y){return U(),P("svg",ve,we)}}),ye={class:"header-actions"},be={class:"token-section"},he={key:0,class:"token-item"},xe={class:"token-info"},Se={class:"token-value"},Ue={key:1,class:"empty-token"},Ce={class:"token-section"},We={class:"game-tokens-list"},Pe={class:"token-header"},Ee={class:"role-info"},$e={class:"role-name"},Re={class:"role-server"},Oe={class:"token-actions"},Le={class:"token-details"},je={class:"detail-item"},Ae={class:"detail-value"},Ne={class:"detail-item"},Me={class:"detail-value"},ze={class:"detail-item"},Fe={class:"detail-value"},Be={class:"detail-item"},Ge={class:"detail-value"},He={class:"detail-item"},Ve={__name:"TokenManager",setup(V){const a=Z(),y=q(),c=Q(),E=Y(),k=l=>{if(!l)return"";const e=l.length;return e<=8?l:l.substring(0,8)+"***"+l.substring(e-8)},v=l=>new Date(l).toLocaleString("zh-CN"),d=l=>c.getWebSocketStatus(l),L=l=>{switch(l){case"connected":return"success";case"error":return"error";case"connecting":return"warning";default:return"default"}},j=l=>{switch(l){case"connected":return"已连接";case"error":return"连接错误";case"connecting":return"连接中";default:return"未连接"}},A=l=>{const e=[{label:"编辑",key:"edit",icon:()=>_(x,null,{default:()=>_(ae)})},{label:"复制Token",key:"copy",icon:()=>_(x,null,{default:()=>_(_e)})}];return l.importMethod==="url"&&l.sourceUrl?e.unshift({label:"从URL刷新",key:"refresh-url",icon:()=>_(x,null,{default:()=>_(le)})}):e.unshift({label:"刷新Token",key:"refresh",icon:()=>_(x,null,{default:()=>_(J)})}),e.push({type:"divider"},{label:"删除",key:"delete",icon:()=>_(x,null,{default:()=>_(re)})}),e},N=(l,e,i)=>{switch(l){case"edit":m();break;case"copy":t(i.token);break;case"refresh":B(e);break;case"refresh-url":b(e,i);break;case"delete":G(e);break}},M=()=>{c.initTokenManager(),a.success("Token数据已刷新")},z=()=>{y.warning({title:"清除用户Token",content:"确定要清除用户认证Token吗？这将会退出登录。",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{c.clearUserToken(),a.success("用户Token已清除")}})},F=(l,e)=>{if(d(l)==="connected")c.closeWebSocketConnection(l),a.info("WebSocket连接已断开");else try{c.createWebSocketConnection(l,e.token,e.wsUrl),a.success("正在建立WebSocket连接...")}catch{a.error("建立WebSocket连接失败")}},B=l=>{const e=c.getGameToken(l);if(!e){a.error("找不到对应的Token数据");return}if(!e.sourceUrl){a.warning("该Token没有配置源地址，无法重新生成。请手动重新导入Token。");return}y.info({title:"重新获取Token",content:"确定要从源地址重新获取此角色的Token吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const i=a.loading("正在重新获取Token...",{duration:0});let u;const r=e.sourceUrl;if(r.startsWith(window.location.origin)||r.startsWith("/")||r.startsWith("http://localhost")||r.startsWith("http://127.0.0.1"))u=await fetch(r);else try{u=await fetch(r,{method:"GET",headers:{Accept:"application/json"},mode:"cors"})}catch(T){throw new Error(`跨域请求被阻止。请确保目标服务器支持CORS。错误详情: ${T.message}`)}if(!u.ok)throw new Error(`请求失败: ${u.status} ${u.statusText}`);const h=await u.json();if(!h.token)throw new Error("返回数据中未找到token字段");c.updateGameToken(l,{token:h.token,server:h.server||e.server,regeneratedAt:new Date().toISOString(),lastRefreshed:new Date().toISOString()}),c.getWebSocketStatus(l)==="connected"&&(c.closeWebSocketConnection(l),setTimeout(()=>{c.createWebSocketConnection(l,h.token,e.wsUrl)},500)),i.destroy(),a.success("Token已成功重新获取")}catch(i){console.error("重新获取Token失败:",i),a.error(i.message||"Token重新获取失败")}}})},G=l=>{y.warning({title:"删除Token",content:"确定要删除此角色的游戏Token吗？这将断开相关的WebSocket连接。",positiveText:"确定删除",negativeText:"取消",onPositiveClick:()=>{c.removeGameToken(l),a.success("Token已删除")}})},m=(l,e)=>{a.info("编辑功能正在开发中")},t=async l=>{try{await navigator.clipboard.writeText(l),a.success("Token已复制到剪贴板")}catch{const i=document.createElement("textarea");i.value=l,document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),a.success("Token已复制到剪贴板")}},b=async(l,e)=>{if(!e.sourceUrl){a.warning("该Token没有配置源URL");return}y.info({title:"从URL刷新Token",content:`确定要从源URL重新获取Token吗？
源地址：${e.sourceUrl}`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const i=a.loading("正在从URL获取新Token...",{duration:0});let u;if(e.sourceUrl.startsWith(window.location.origin)||e.sourceUrl.startsWith("/")||e.sourceUrl.startsWith("http://localhost")||e.sourceUrl.startsWith("http://127.0.0.1"))u=await fetch(e.sourceUrl);else{const h=`/api/proxy?url=${encodeURIComponent(e.sourceUrl)}`;u=await fetch(h)}if(!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);const R=await u.json();if(!R.token)throw new Error("返回数据中未找到token字段");c.updateGameToken(l,{token:R.token,lastUsed:new Date().toISOString()}),i.destroy(),a.success("Token刷新成功")}catch(i){console.error("URL刷新Token失败:",i),a.error("刷新失败: "+i.message)}}})},f=()=>{try{const l=c.exportTokens(),e=JSON.stringify(l,null,2),i=new Blob([e],{type:"application/json"}),u=document.createElement("a");u.href=URL.createObjectURL(i),u.download=`tokens_backup_${new Date().toISOString().split("T")[0]}.json`,u.click(),a.success("Token数据已导出")}catch(l){a.error("导出失败: "+l.message)}},$=({file:l})=>{const e=new FileReader;e.onload=i=>{try{const u=JSON.parse(i.target.result),r=c.importTokens(u);r.success?(a.success(r.message),E.fetchGameRoles()):a.error(r.message)}catch{a.error("导入失败：文件格式错误")}},e.readAsText(l.file)},O=()=>{y.info({title:"清理过期Token",content:"确定要清理超过24小时未使用的Token吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{const l=c.cleanExpiredTokens();a.success(`已清理 ${l} 个过期Token`)}})},W=()=>{y.error({title:"清除所有Token",content:"确定要清除所有游戏Token吗？这将断开所有WebSocket连接。此操作不可恢复！",positiveText:"确定清除",negativeText:"取消",onPositiveClick:()=>{c.clearAllGameTokens(),a.success("所有游戏Token已清除")}})};return(l,e)=>{const i=C("n-button"),u=C("n-upload"),r=C("n-dropdown"),R=C("n-tag"),h=K;return U(),ue(h,null,{extra:s(()=>[o("div",ye,[n(i,{size:"small",onClick:M},{icon:s(()=>[n(g(x),null,{default:s(()=>[n(g(J))]),_:1})]),default:s(()=>[e[0]||(e[0]=o("span",{class:"btn-text"},"刷新",-1))]),_:1}),n(i,{size:"small",type:"warning",onClick:f},{icon:s(()=>[...e[1]||(e[1]=[o("i",{class:"i-mdi:download"},null,-1)])]),default:s(()=>[e[2]||(e[2]=o("span",{class:"btn-text"},"导出",-1))]),_:1}),n(u,{"show-file-list":!1,accept:".json",onChange:$},{default:s(()=>[n(i,{size:"small",type:"info"},{icon:s(()=>[n(g(x),null,{default:s(()=>[n(g(se))]),_:1})]),default:s(()=>[e[3]||(e[3]=o("span",{class:"btn-text"},"导入",-1))]),_:1})]),_:1})])]),default:s(()=>[o("div",be,[e[7]||(e[7]=o("h4",null,"用户认证Token",-1)),g(c).userToken?(U(),P("div",he,[o("div",xe,[e[4]||(e[4]=o("span",{class:"token-label"},"Token:",-1)),o("span",Se,w(k(g(c).userToken)),1)]),n(i,{size:"tiny",type:"error",onClick:z},{default:s(()=>[...e[5]||(e[5]=[p(" 清除 ",-1)])]),_:1})])):(U(),P("div",Ue,[...e[6]||(e[6]=[o("span",null,"未设置用户Token",-1)])]))]),o("div",Ce,[o("h4",null," 游戏角色Token ("+w(Object.keys(g(c).gameTokens).length)+"个) ",1),o("div",We,[(U(!0),P(de,null,ce(g(c).gameTokens,(T,S)=>(U(),P("div",{key:S,class:"game-token-item"},[o("div",Pe,[o("div",Ee,[o("span",$e,w(T.roleName),1),o("span",Re,w(T.server),1)]),o("div",Oe,[n(i,{size:"tiny",type:d(S)==="connected"?"success":"default",onClick:I=>F(S,T)},{default:s(()=>[p(w(d(S)==="connected"?"断开WS":"连接WS"),1)]),_:2},1032,["type","onClick"]),n(r,{options:A(T),trigger:"click",onSelect:I=>N(I,S,T)},{default:s(()=>[n(i,{size:"tiny",type:"tertiary"},{icon:s(()=>[n(g(x),null,{default:s(()=>[n(g(ne))]),_:1})]),_:1})]),_:1},8,["options","onSelect"])])]),o("div",Le,[o("div",je,[e[8]||(e[8]=o("span",{class:"detail-label"},"Token:",-1)),o("span",Ae,w(k(T.token)),1)]),o("div",Ne,[e[9]||(e[9]=o("span",{class:"detail-label"},"WebSocket URL:",-1)),o("span",Me,w(T.wsUrl),1)]),o("div",ze,[e[10]||(e[10]=o("span",{class:"detail-label"},"创建时间:",-1)),o("span",Fe,w(v(T.createdAt)),1)]),o("div",Be,[e[11]||(e[11]=o("span",{class:"detail-label"},"最后使用:",-1)),o("span",Ge,w(v(T.lastUsed)),1)]),o("div",He,[e[12]||(e[12]=o("span",{class:"detail-label"},"连接状态:",-1)),n(R,{size:"small",type:L(d(S))},{default:s(()=>[p(w(j(d(S))),1)]),_:2},1032,["type"])])])]))),128))])])]),actions:s(()=>[n(i,{type:"warning",onClick:O},{default:s(()=>[...e[13]||(e[13]=[p(" 清理过期Token ",-1)])]),_:1}),n(i,{type:"error",onClick:W},{default:s(()=>[...e[14]||(e[14]=[p(" 清除所有Token ",-1)])]),_:1})]),_:1})}}},Ie=X(Ve,[["__scopeId","data-v-a3e17dfd"]]),Je={class:"profile-page"},Xe={class:"container"},Ze={class:"security-items"},qe={class:"security-item"},Ke={class:"security-item"},Qe={class:"security-item"},Ye={class:"security-item danger"},De={__name:"Profile",setup(V){ke();const a=Z(),y=q(),c=fe(),E=pe(null),k=H({username:"",email:"",nickname:"",phone:"",avatar:""}),v=H({currentPassword:"",newPassword:"",confirmPassword:""}),d=H({theme:"auto",language:"zh-CN",notifications:!0,autoExecute:!1}),L=[{label:"跟随系统",value:"auto"},{label:"浅色主题",value:"light"},{label:"深色主题",value:"dark"}],j=[{label:"简体中文",value:"zh-CN"},{label:"English",value:"en-US"}],A=async()=>{try{a.success("个人信息保存成功")}catch{a.error("保存失败，请稍后重试")}},N=async()=>{if(E.value)try{await E.value.validate(),a.success("密码修改成功"),Object.keys(v).forEach(m=>{v[m]=""})}catch{}},M=m=>{d.theme=m,localStorage.setItem("theme",m),m==="dark"?document.documentElement.setAttribute("data-theme","dark"):m==="light"?document.documentElement.removeAttribute("data-theme"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme")},z=()=>{a.info("两步验证设置功能开发中...")},F=()=>{a.info("登录历史查看功能开发中...")},B=()=>{a.info("数据导出功能开发中...")},G=()=>{y.warning({title:"删除账户",content:"此操作将永久删除您的账户和所有数据，且无法恢复。确定要继续吗？",positiveText:"确定删除",negativeText:"取消",onPositiveClick:()=>{a.error("账户删除功能暂未开放")}})};return me(()=>{c.userInfo&&Object.assign(k,c.userInfo);const m=localStorage.getItem("userPreferences");if(m)try{Object.assign(d,JSON.parse(m))}catch(t){console.error("解析用户偏好失败:",t)}}),(m,t)=>{const b=te,f=ee,$=D,O=oe,W=K,l=C("n-select"),e=C("n-switch"),i=Ie,u=C("n-button");return U(),P("div",Je,[o("div",Xe,[t[25]||(t[25]=o("div",{class:"page-header"},[o("h1",null,"个人资料"),o("p",null,"管理您的账户信息和偏好设置")],-1)),t[26]||(t[26]=o("h2",null,"基本信息",-1)),n(W,null,{actions:s(()=>[n(O,{type:"primary",onClick:A},{default:s(()=>[...t[11]||(t[11]=[p(" 保存更改 ",-1)])]),_:1})]),default:s(()=>[n($,{model:k,"label-placement":"left","label-width":"80px"},{default:s(()=>[n(f,{label:"用户名"},{default:s(()=>[n(b,{value:k.username,"onUpdate:value":t[0]||(t[0]=r=>k.username=r),readonly:""},null,8,["value"])]),_:1}),n(f,{label:"邮箱"},{default:s(()=>[n(b,{value:k.email,"onUpdate:value":t[1]||(t[1]=r=>k.email=r)},null,8,["value"])]),_:1}),n(f,{label:"昵称"},{default:s(()=>[n(b,{value:k.nickname,"onUpdate:value":t[2]||(t[2]=r=>k.nickname=r),placeholder:"请输入昵称"},null,8,["value"])]),_:1}),n(f,{label:"手机"},{default:s(()=>[n(b,{value:k.phone,"onUpdate:value":t[3]||(t[3]=r=>k.phone=r),placeholder:"请输入手机号"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),t[27]||(t[27]=o("h2",null,"密码修改",-1)),n(W,null,{actions:s(()=>[n(O,{type:"primary",onClick:N},{default:s(()=>[...t[12]||(t[12]=[p(" 修改密码 ",-1)])]),_:1})]),default:s(()=>[n($,{model:v,ref_key:"passwordFormRef",ref:E,"label-placement":"left","label-width":"100px"},{default:s(()=>[n(f,{label:"当前密码",prop:"currentPassword"},{default:s(()=>[n(b,{value:v.currentPassword,"onUpdate:value":t[4]||(t[4]=r=>v.currentPassword=r),type:"password",placeholder:"请输入当前密码"},null,8,["value"])]),_:1}),n(f,{label:"新密码",prop:"newPassword"},{default:s(()=>[n(b,{value:v.newPassword,"onUpdate:value":t[5]||(t[5]=r=>v.newPassword=r),type:"password",placeholder:"请输入新密码"},null,8,["value"])]),_:1}),n(f,{label:"确认新密码",prop:"confirmPassword"},{default:s(()=>[n(b,{value:v.confirmPassword,"onUpdate:value":t[6]||(t[6]=r=>v.confirmPassword=r),type:"password",placeholder:"请再次输入新密码"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),t[28]||(t[28]=o("h2",null,"系统偏好",-1)),n(W,null,{default:s(()=>[n($,null,{default:s(()=>[n(f,{label:"主题设置"},{extra:s(()=>[...t[13]||(t[13]=[p(" 选择您喜欢的界面主题 ",-1)])]),default:s(()=>[n(l,{value:d.theme,"onUpdate:value":[t[7]||(t[7]=r=>d.theme=r),M],options:L},null,8,["value"])]),_:1}),n(f,{label:"语言设置"},{extra:s(()=>[...t[14]||(t[14]=[p(" 选择界面显示语言 ",-1)])]),default:s(()=>[n(l,{value:d.language,"onUpdate:value":t[8]||(t[8]=r=>d.language=r),options:j},null,8,["value"])]),_:1}),n(f,{label:"通知设置"},{extra:s(()=>[...t[15]||(t[15]=[p(" 接收任务完成通知 ",-1)])]),default:s(()=>[n(e,{value:d.notifications,"onUpdate:value":t[9]||(t[9]=r=>d.notifications=r)},null,8,["value"])]),_:1}),n(f,{label:"自动执行"},{extra:s(()=>[...t[16]||(t[16]=[p(" 默认开启任务自动执行 ",-1)])]),default:s(()=>[n(e,{value:d.autoExecute,"onUpdate:value":t[10]||(t[10]=r=>d.autoExecute=r)},null,8,["value"])]),_:1})]),_:1})]),_:1}),t[29]||(t[29]=o("h2",null,"Token管理",-1)),n(i),t[30]||(t[30]=o("h2",null,"账户安全",-1)),n(W,null,{default:s(()=>[o("div",Ze,[o("div",qe,[t[18]||(t[18]=o("div",{class:"security-info"},[o("h3",null,"两步验证"),o("p",null,"为您的账户添加额外的安全保护")],-1)),n(u,{onClick:z},{default:s(()=>[...t[17]||(t[17]=[p(" 设置 ",-1)])]),_:1})]),o("div",Ke,[t[20]||(t[20]=o("div",{class:"security-info"},[o("h3",null,"登录历史"),o("p",null,"查看最近的登录记录")],-1)),n(u,{onClick:F},{default:s(()=>[...t[19]||(t[19]=[p(" 查看 ",-1)])]),_:1})]),o("div",Qe,[t[22]||(t[22]=o("div",{class:"security-info"},[o("h3",null,"数据导出"),o("p",null,"导出您的所有数据")],-1)),n(u,{onClick:B},{default:s(()=>[...t[21]||(t[21]=[p(" 导出 ",-1)])]),_:1})]),o("div",Ye,[t[24]||(t[24]=o("div",{class:"security-info"},[o("h3",null,"删除账户"),o("p",null,"永久删除您的账户和所有数据")],-1)),n(u,{type:"error",onClick:G},{default:s(()=>[...t[23]||(t[23]=[p(" 删除 ",-1)])]),_:1})])])]),_:1})])])}}},pt=X(De,[["__scopeId","data-v-709f5aa1"]]);export{pt as default};
