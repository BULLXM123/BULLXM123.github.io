import{c as we,u as ye,t as ge}from"./index-DyiAMGIZ.js";import{g as be,u as Pe,k as Te,l as U,m as J,U as Ie,L as ke,o as Ee,p as xe,q as Qe,r as ie,N as Ce}from"./ui-vendor-bYSxkbvo.js";import{C as Ne}from"./CloudUpload-jfh8uwlP.js";import{k as Ae,r as ae,e as Me,X as K,$ as T,N as b,U as q,Z as P,V as N,S as Oe,F as Se,R as ze,j as V,a2 as ee,Y as Le}from"./vue-vendor-CjWJpnUV.js";import{_ as $e}from"./plugin-vueexport-helper-DlAUqK2U.js";import"./utils-C42QaX6I.js";var de={exports:{}};(function(a){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function d(s,o,f){this.fn=s,this.context=o,this.once=f||!1}function v(s,o,f,c,g){if(typeof f!="function")throw new TypeError("The listener must be a function");var y=new d(f,c||s,g),l=t?t+o:o;return s._events[l]?s._events[l].fn?s._events[l]=[s._events[l],y]:s._events[l].push(y):(s._events[l]=y,s._eventsCount++),s}function _(s,o){--s._eventsCount===0?s._events=new n:delete s._events[o]}function m(){this._events=new n,this._eventsCount=0}m.prototype.eventNames=function(){var o=[],f,c;if(this._eventsCount===0)return o;for(c in f=this._events)e.call(f,c)&&o.push(t?c.slice(1):c);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(f)):o},m.prototype.listeners=function(o){var f=t?t+o:o,c=this._events[f];if(!c)return[];if(c.fn)return[c.fn];for(var g=0,y=c.length,l=new Array(y);g<y;g++)l[g]=c[g].fn;return l},m.prototype.listenerCount=function(o){var f=t?t+o:o,c=this._events[f];return c?c.fn?1:c.length:0},m.prototype.emit=function(o,f,c,g,y,l){var i=t?t+o:o;if(!this._events[i])return!1;var u=this._events[i],E=arguments.length,x,h;if(u.fn){switch(u.once&&this.removeListener(o,u.fn,void 0,!0),E){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,f),!0;case 3:return u.fn.call(u.context,f,c),!0;case 4:return u.fn.call(u.context,f,c,g),!0;case 5:return u.fn.call(u.context,f,c,g,y),!0;case 6:return u.fn.call(u.context,f,c,g,y,l),!0}for(h=1,x=new Array(E-1);h<E;h++)x[h-1]=arguments[h];u.fn.apply(u.context,x)}else{var C=u.length,z;for(h=0;h<C;h++)switch(u[h].once&&this.removeListener(o,u[h].fn,void 0,!0),E){case 1:u[h].fn.call(u[h].context);break;case 2:u[h].fn.call(u[h].context,f);break;case 3:u[h].fn.call(u[h].context,f,c);break;case 4:u[h].fn.call(u[h].context,f,c,g);break;default:if(!x)for(z=1,x=new Array(E-1);z<E;z++)x[z-1]=arguments[z];u[h].fn.apply(u[h].context,x)}}return!0},m.prototype.on=function(o,f,c){return v(this,o,f,c,!1)},m.prototype.once=function(o,f,c){return v(this,o,f,c,!0)},m.prototype.removeListener=function(o,f,c,g){var y=t?t+o:o;if(!this._events[y])return this;if(!f)return _(this,y),this;var l=this._events[y];if(l.fn)l.fn===f&&(!g||l.once)&&(!c||l.context===c)&&_(this,y);else{for(var i=0,u=[],E=l.length;i<E;i++)(l[i].fn!==f||g&&!l[i].once||c&&l[i].context!==c)&&u.push(l[i]);u.length?this._events[y]=u.length===1?u[0]:u:_(this,y)}return this},m.prototype.removeAllListeners=function(o){var f;return o?(f=t?t+o:o,this._events[f]&&_(this,f)):(this._events=new n,this._eventsCount=0),this},m.prototype.off=m.prototype.removeListener,m.prototype.addListener=m.prototype.on,m.prefixed=t,m.EventEmitter=m,a.exports=m})(de);var Fe=de.exports;const We=be(Fe);class me extends Error{constructor(e){super(e),this.name="TimeoutError"}}let Be=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const oe=a=>globalThis.DOMException===void 0?new Be(a):new DOMException(a),ue=a=>{const e=a.reason===void 0?oe("This operation was aborted."):a.reason;return e instanceof Error?e:oe(e)};function Ue(a,e,t,n){let d;const v=new Promise((_,m)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){_(a);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){const{signal:s}=n;s.aborted&&m(ue(s)),s.addEventListener("abort",()=>{m(ue(s))})}d=n.customTimers.setTimeout.call(void 0,()=>{const s=`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new me(s);typeof a.cancel=="function"&&a.cancel(),m(o)},e),(async()=>{try{_(await a)}catch(s){m(s)}finally{n.customTimers.clearTimeout.call(void 0,d)}})()});return v.clear=()=>{clearTimeout(d),d=void 0},v}function qe(a,e,t){let n=0,d=a.length;for(;d>0;){const v=Math.trunc(d/2);let _=n+v;t(a[_],e)<=0?(n=++_,d-=v+1):d=v}return n}var S=function(a,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?a!==e||!n:!e.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(a):n?n.value:e.get(a)},A;class Ve{constructor(){A.set(this,[])}enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,run:e};if(this.size&&S(this,A,"f")[this.size-1].priority>=t.priority){S(this,A,"f").push(n);return}const d=qe(S(this,A,"f"),n,(v,_)=>_.priority-v.priority);S(this,A,"f").splice(d,0,n)}dequeue(){const e=S(this,A,"f").shift();return e==null?void 0:e.run}filter(e){return S(this,A,"f").filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return S(this,A,"f").length}}A=new WeakMap;var p=function(a,e,t,n,d){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!d)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?a!==e||!d:!e.has(a))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?d.call(a,t):d?d.value=t:e.set(a,t),t},r=function(a,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?a!==e||!n:!e.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(a):n?n.value:e.get(a)},w,$,F,O,X,W,D,Q,L,I,R,k,B,M,j,le,fe,ve,ce,he,Y,te,re,Z,_e,G;class pe extends Error{}class De extends We{constructor(e){var t,n,d,v;if(super(),w.add(this),$.set(this,void 0),F.set(this,void 0),O.set(this,0),X.set(this,void 0),W.set(this,void 0),D.set(this,0),Q.set(this,void 0),L.set(this,void 0),I.set(this,void 0),R.set(this,void 0),k.set(this,0),B.set(this,void 0),M.set(this,void 0),j.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ve,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(v=(d=e.interval)===null||d===void 0?void 0:d.toString())!==null&&v!==void 0?v:""}\` (${typeof e.interval})`);p(this,$,e.carryoverConcurrencyCount,"f"),p(this,F,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),p(this,X,e.intervalCap,"f"),p(this,W,e.interval,"f"),p(this,I,new e.queueClass,"f"),p(this,R,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,p(this,j,e.throwOnTimeout===!0,"f"),p(this,M,e.autoStart===!1,"f")}get concurrency(){return r(this,B,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);p(this,B,e,"f"),r(this,w,"m",Z).call(this)}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:r(this,j,"f"),...t},new Promise((n,d)=>{r(this,I,"f").enqueue(async()=>{var v,_,m;p(this,k,(_=r(this,k,"f"),_++,_),"f"),p(this,O,(m=r(this,O,"f"),m++,m),"f");try{if(!((v=t.signal)===null||v===void 0)&&v.aborted)throw new pe("The task was aborted.");let s=e({signal:t.signal});t.timeout&&(s=Ue(Promise.resolve(s),t.timeout)),t.signal&&(s=Promise.race([s,r(this,w,"m",_e).call(this,t.signal)]));const o=await s;n(o),this.emit("completed",o)}catch(s){if(s instanceof me&&!t.throwOnTimeout){n();return}d(s),this.emit("error",s)}finally{r(this,w,"m",ve).call(this)}},t),this.emit("add"),r(this,w,"m",Y).call(this)})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return r(this,M,"f")?(p(this,M,!1,"f"),r(this,w,"m",Z).call(this),this):this}pause(){p(this,M,!0,"f")}clear(){p(this,I,new(r(this,R,"f")),"f")}async onEmpty(){r(this,I,"f").size!==0&&await r(this,w,"m",G).call(this,"empty")}async onSizeLessThan(e){r(this,I,"f").size<e||await r(this,w,"m",G).call(this,"next",()=>r(this,I,"f").size<e)}async onIdle(){r(this,k,"f")===0&&r(this,I,"f").size===0||await r(this,w,"m",G).call(this,"idle")}get size(){return r(this,I,"f").size}sizeBy(e){return r(this,I,"f").filter(e).length}get pending(){return r(this,k,"f")}get isPaused(){return r(this,M,"f")}}$=new WeakMap,F=new WeakMap,O=new WeakMap,X=new WeakMap,W=new WeakMap,D=new WeakMap,Q=new WeakMap,L=new WeakMap,I=new WeakMap,R=new WeakMap,k=new WeakMap,B=new WeakMap,M=new WeakMap,j=new WeakMap,w=new WeakSet,le=function(){return r(this,F,"f")||r(this,O,"f")<r(this,X,"f")},fe=function(){return r(this,k,"f")<r(this,B,"f")},ve=function(){var e;p(this,k,(e=r(this,k,"f"),e--,e),"f"),r(this,w,"m",Y).call(this),this.emit("next")},ce=function(){r(this,w,"m",re).call(this),r(this,w,"m",te).call(this),p(this,L,void 0,"f")},he=function(){const e=Date.now();if(r(this,Q,"f")===void 0){const t=r(this,D,"f")-e;if(t<0)p(this,O,r(this,$,"f")?r(this,k,"f"):0,"f");else return r(this,L,"f")===void 0&&p(this,L,setTimeout(()=>{r(this,w,"m",ce).call(this)},t),"f"),!0}return!1},Y=function(){if(r(this,I,"f").size===0)return r(this,Q,"f")&&clearInterval(r(this,Q,"f")),p(this,Q,void 0,"f"),this.emit("empty"),r(this,k,"f")===0&&this.emit("idle"),!1;if(!r(this,M,"f")){const e=!r(this,w,"a",he);if(r(this,w,"a",le)&&r(this,w,"a",fe)){const t=r(this,I,"f").dequeue();return t?(this.emit("active"),t(),e&&r(this,w,"m",te).call(this),!0):!1}}return!1},te=function(){r(this,F,"f")||r(this,Q,"f")!==void 0||(p(this,Q,setInterval(()=>{r(this,w,"m",re).call(this)},r(this,W,"f")),"f"),p(this,D,Date.now()+r(this,W,"f"),"f"))},re=function(){r(this,O,"f")===0&&r(this,k,"f")===0&&r(this,Q,"f")&&(clearInterval(r(this,Q,"f")),p(this,Q,void 0,"f")),p(this,O,r(this,$,"f")?r(this,k,"f"):0,"f"),r(this,w,"m",Z).call(this)},Z=function(){for(;r(this,w,"m",Y).call(this););},_e=async function(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(new pe("The task was aborted."))},{once:!0})})},G=async function(e,t){return new Promise(n=>{const d=()=>{t&&!t()||(this.off(e,d),n())};this.on(e,d)})};const Re={style:{"word-break":"break-all"}},je={class:"optional-fields"},Ye={class:"form-actions"},Ge=Ae({__name:"bin",emits:["cancel","ok"],setup(a,{emit:e}){const t=e,{storeArrayBuffer:n}=we(),d=()=>{o.value=[],t("cancel")},v=ye(),_=Pe(),m=ae(!1),s=Me({name:"",server:"",wsUrl:"",importMethod:""}),o=ae([]),f=new De({concurrency:1,interval:1e3}),c=l=>{if(!l)return;l=l.trim();let i=l.match(/^bin-(.*?)服-([0-2])-([0-9]{6,12})-(.*)\.bin$/);return console.log(i),i?(s.name=`${i[1]}_${i[2]}_${i[4]}`,{server:i[1],roleIndex:i[2],roleId:i[3],roleName:i[4]}):{server:"",roleIndex:"",roleId:"",roleName:s.name||""}},g=l=>(f.add(async()=>{console.log("上传文件数据:",l);const i=c(l.name),u=new FileReader;u.onload=async E=>{var ne,se;const x=(ne=E.target)==null?void 0:ne.result,h=await ge(x),C=i.roleName||((se=l.name.split("."))==null?void 0:se[0])||"";if(n(C,x),o.value.some(H=>H.name===C)){_.error("上传列表中已存在同名角色! ");return}v.gameTokens.find(H=>H.name===C)&&_.warning(`角色"${C}"已存在，将更新该角色的Token`),_.success("Token读取成功，请检查角色名称等信息后提交"),o.value.push({name:C,token:h,server:i.server+""+i.roleIndex||"",wsUrl:s.wsUrl||"",importMethod:"bin"})},u.onerror=()=>{_.error("读取文件失败，请重试")},u.readAsArrayBuffer(l)}),!1),y=async()=>{if(o.value.length===0){_.error("请先上传bin文件！");return}o.value.forEach(l=>{const i=v.gameTokens.find(u=>u.name===l.name);i?(console.log("移除同名token:",i),v.updateToken(i.id,{...l})):v.addToken({...l})}),console.log("当前Token列表:",v.gameTokens),_.success("Token添加成功"),o.value=[],t("ok")};return(l,i)=>{const u=Ie,E=Ee,x=ke;return q(),K(b(Te),{model:s,"label-placement":"top",size:"large","show-label":!0},{default:T(()=>[P(b(U),{label:"游戏角色名称","show-label":!0},{default:T(()=>[P(b(J),{value:s.name,"onUpdate:value":i[0]||(i[0]=h=>s.name=h),placeholder:"例如：主号战士",clearable:""},null,8,["value"])]),_:1}),P(b(U),{label:"bin文件","show-label":!0},{default:T(()=>[P(u,{multiple:"",accept:"*.bin,*.dmp",onBeforeUpload:g,draggable:"",dropzone:"",placeholder:"粘贴Token字符串...",clearable:""})]),_:1}),P(x,null,{default:T(()=>[(q(!0),Oe(Se,null,ze(o.value,(h,C)=>(q(),K(E,{key:C},{default:T(()=>[N("div",null,[i[3]||(i[3]=N("strong",null,"角色名称:",-1)),V(" "+ee(h.name||"未命名角色"),1),i[4]||(i[4]=N("br",null,null,-1)),i[5]||(i[5]=N("strong",null,"Token:",-1)),N("span",Re,ee(h.token),1),i[6]||(i[6]=N("br",null,null,-1)),i[7]||(i[7]=N("strong",null,"服务器:",-1)),V(" "+ee(h.server||"未指定"),1)])]),_:2},1024))),128))]),_:1}),P(b(xe),null,{default:T(()=>[P(b(Qe),{title:"角色详情 (可选)",name:"optional"},{default:T(()=>[N("div",je,[P(b(U),{label:"服务器"},{default:T(()=>[P(b(J),{value:s.server,"onUpdate:value":i[1]||(i[1]=h=>s.server=h),placeholder:"服务器名称"},null,8,["value"])]),_:1}),P(b(U),{label:"自定义连接地址"},{default:T(()=>[P(b(J),{value:s.wsUrl,"onUpdate:value":i[2]||(i[2]=h=>s.wsUrl=h),placeholder:"留空使用默认连接"},null,8,["value"])]),_:1})])]),_:1})]),_:1}),N("div",Ye,[P(b(ie),{type:"primary",size:"large",block:"",loading:m.value,onClick:y},{icon:T(()=>[P(b(Ce),null,{default:T(()=>[P(b(Ne))]),_:1})]),default:T(()=>[i[8]||(i[8]=V(" 添加Token ",-1))]),_:1},8,["loading"]),b(v).hasTokens?(q(),K(b(ie),{key:0,size:"large",block:"",onClick:d},{default:T(()=>[...i[9]||(i[9]=[V(" 取消 ",-1)])]),_:1})):Le("",!0)])]),_:1},8,["model"])}}}),rt=$e(Ge,[["__scopeId","data-v-e1d2f3d2"]]);export{rt as default};
