const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/BatchDailyTasks-xsGq_iQa.js","assets/vue-vendor-CjWJpnUV.js","assets/plugin-vueexport-helper-DlAUqK2U.js","assets/ui-vendor-bYSxkbvo.js","assets/Settings-C4JVFvuj.js","assets/utils-C42QaX6I.js","assets/BatchDailyTasks-326mCmEN.css","assets/Changelog-Bhn1qfGs.js","assets/Changelog-Bnwqe2ki.css","assets/DailyTasks-ltEBlPa3.js","assets/Time-D8Vw7IVu.js","assets/gameRoles-C_H-ZCPA.js","assets/localTokenManager-DDQzZcWL.js","assets/auth-CeEVJIiN.js","assets/Refresh-DEl0-b7R.js","assets/ChevronDown-DPGM6gLr.js","assets/Search-CTXXI-Ll.js","assets/Cube-DjtpYigb.js","assets/DailyTasks-l3U_1-fD.css","assets/Dashboard-DHUptxYs.js","assets/PersonCircle-DQ9VUGcu.js","assets/CheckmarkCircle-B69P8Rl0.js","assets/Add-Cfs4ZWp-.js","assets/Dashboard-DB3XSwG6.css","assets/GameFeatures-C0ZYo-ey.js","assets/Copy-By9v4eRW.js","assets/xiaoyugan-Dwisk7G8.js","assets/GameFeatures-BU-egoDY.css","assets/GameRoles-Bjc4vX3H.js","assets/EllipsisHorizontal-DSgZjaEv.js","assets/GameRoles-zbG5YO2o.css","assets/Home-D_-7XTmr.js","assets/Ribbon-BRktUUem.js","assets/Menu-CRkbBSGB.js","assets/Home-DwMyqZy6.css","assets/Login-CctLh2SZ.js","assets/Login-BZK0AGru.css","assets/NotFound-CY7ZVWh_.js","assets/NotFound-B55E7a13.css","assets/Profile-CThMevbB.js","assets/CloudUpload-jfh8uwlP.js","assets/TrashBin-C9UW3eMC.js","assets/Profile-DkaTx4fg.css","assets/Register-BFXItiFp.js","assets/Register-P6HEMnVo.css","assets/index-BQ_7dm-_.js","assets/ThemeToggle-DQaWFXx2.js","assets/ThemeToggle-BxJlr-fY.css","assets/manual-BZOVq2EX.js","assets/AlertCircleOutline-C052Kwii.js","assets/manual-CAeAMw_T.css","assets/url-C1Mr_lFd.js","assets/url-BToZl6Sx.css","assets/bin-IuckmPD9.js","assets/bin-tzaMc3gW.css","assets/index-BCmH69m4.css","assets/DefaultLayout-DTMdajZ2.js","assets/DefaultLayout-DoTwvOV_.css","assets/MessageTester-Dk_HE8GA.js","assets/MessageTester-XpLiTs7u.css","assets/WebSocketTester-DHtad7hQ.js","assets/WebSocketTester-BX5skuHJ.css"])))=>i.map(i=>d[i]);
import{r as W,c as $e,ac as rr,ad as nr,ae as sr,o as yt,E as bt,X as or,W as pe,U as ir,$ as Te,Z as ke,V as ar,M as cr,af as ur}from"./vue-vendor-CjWJpnUV.js";import{h as Ge,u as ve,a as lr}from"./utils-C42QaX6I.js";import{g as dr,d as fr,n as hr}from"./ui-vendor-bYSxkbvo.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=r(o);fetch(o.href,i)}})();const mr="modulepreload",gr=function(t){return"/"+t},ut={},I=function(e,r,n){let o=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),d=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(r.map(p=>{if(p=gr(p),p in ut)return;ut[p]=!0;const v=p.endsWith(".css"),T=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${T}`))return;const b=document.createElement("link");if(b.rel=v?"stylesheet":mr,v||(b.as="script"),b.crossOrigin="",b.href=p,d&&b.setAttribute("nonce",d),document.head.appendChild(b),v)return new Promise((F,Q)=>{b.addEventListener("load",F),b.addEventListener("error",()=>Q(new Error(`Unable to preload CSS for ${p}`)))})}))}function i(c){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=c,window.dispatchEvent(d),!d.defaultPrevented)throw c}return o.then(c=>{for(const d of c||[])d.status==="rejected"&&i(d.reason);return e().catch(i)})},pr=[{path:"/BatchDailyTasks",name:"/BatchDailyTasks",component:()=>I(()=>import("./BatchDailyTasks-xsGq_iQa.js"),__vite__mapDeps([0,1,2,3,4,5,6]))},{path:"/Changelog",name:"/Changelog",component:()=>I(()=>import("./Changelog-Bhn1qfGs.js"),__vite__mapDeps([7,1,2,8]))},{path:"/DailyTasks",name:"/DailyTasks",component:()=>I(()=>import("./DailyTasks-ltEBlPa3.js"),__vite__mapDeps([9,1,2,4,10,3,11,12,13,14,15,16,17,5,18]))},{path:"/Dashboard",name:"/Dashboard",component:()=>I(()=>import("./Dashboard-DHUptxYs.js"),__vite__mapDeps([19,1,2,20,21,10,17,22,4,3,5,23]))},{path:"/GameFeatures",name:"/GameFeatures",component:()=>I(()=>import("./GameFeatures-C0ZYo-ey.js"),__vite__mapDeps([24,2,3,1,14,25,4,21,26,5,27]))},{path:"/GameRoles",name:"/GameRoles",component:()=>I(()=>import("./GameRoles-Bjc4vX3H.js"),__vite__mapDeps([28,1,11,12,2,22,29,20,3,5,30]))},{path:"/Home",name:"/Home",component:()=>I(()=>import("./Home-D_-7XTmr.js"),__vite__mapDeps([31,26,1,13,12,2,20,17,32,4,33,5,3,34]))},{path:"/Login",name:"/Login",component:()=>I(()=>import("./Login-CctLh2SZ.js"),__vite__mapDeps([35,1,26,13,12,2,20,17,32,4,3,5,36]))},{path:"/NotFound",name:"/NotFound",component:()=>I(()=>import("./NotFound-CY7ZVWh_.js"),__vite__mapDeps([37,1,2,16,38]))},{path:"/Profile",name:"/Profile",component:()=>I(()=>import("./Profile-CThMevbB.js"),__vite__mapDeps([39,12,1,11,2,3,29,14,40,41,13,5,42]))},{path:"/Register",name:"/Register",component:()=>I(()=>import("./Register-BFXItiFp.js"),__vite__mapDeps([43,1,26,13,12,2,20,3,5,44]))},{path:"/TokenImport",children:[{path:"",name:"/TokenImport/",component:()=>I(()=>import("./index-BQ_7dm-_.js"),__vite__mapDeps([45,46,1,2,47,26,48,3,49,40,5,50,51,52,53,54,22,33,41,14,29,25,55]))},{path:"bin",name:"/TokenImport/bin",component:()=>I(()=>import("./bin-IuckmPD9.js"),__vite__mapDeps([53,3,1,40,2,5,54]))},{path:"manual",name:"/TokenImport/manual",component:()=>I(()=>import("./manual-BZOVq2EX.js"),__vite__mapDeps([48,3,1,49,40,2,5,50]))},{path:"url",name:"/TokenImport/url",component:()=>I(()=>import("./url-C1Mr_lFd.js"),__vite__mapDeps([51,5,1,40,3,2,52]))}]}];var Tt={},kt={},he={};he.hashU32=function(e){return e=e|0,e=e+2127912214+(e<<12)|0,e=e^-949894596^e>>>19,e=e+374761393+(e<<5)|0,e=e+-744332180^e<<9,e=e+-42973499+(e<<3)|0,e^-1252372727^e>>>16|0};he.readU64=function(e,r){var n=0;return n|=e[r++]<<0,n|=e[r++]<<8,n|=e[r++]<<16,n|=e[r++]<<24,n|=e[r++]<<32,n|=e[r++]<<40,n|=e[r++]<<48,n|=e[r++]<<56,n};he.readU32=function(e,r){var n=0;return n|=e[r++]<<0,n|=e[r++]<<8,n|=e[r++]<<16,n|=e[r++]<<24,n};he.writeU32=function(e,r,n){e[r++]=n>>0&255,e[r++]=n>>8&255,e[r++]=n>>16&255,e[r++]=n>>24&255};he.imul=function(e,r){var n=e>>>16,o=e&65535,i=r>>>16,c=r&65535;return o*c+(n*c+o*i<<16)|0};var Y=he,ce=2654435761,ue=2246822519,St=3266489917,wr=668265263,Dt=374761393;function Ue(t,e){return t=t|0,e=e|0,t>>>(32-e|0)|t<<e|0}function Et(t,e,r){return t=t|0,e=e|0,r=r|0,Y.imul(t>>>(32-e|0)|t<<e,r)|0}function He(t,e){return t=t|0,e=e|0,t>>>e^t|0}function Ee(t,e,r,n,o){return Et(Y.imul(e,r)+t,n,o)}function _r(t,e,r){return Et(t+Y.imul(e[r],Dt),11,ce)}function vr(t,e,r){return Ee(t,Y.readU32(e,r),St,17,wr)}function yr(t,e,r){return[Ee(t[0],Y.readU32(e,r+0),ue,13,ce),Ee(t[1],Y.readU32(e,r+4),ue,13,ce),Ee(t[2],Y.readU32(e,r+8),ue,13,ce),Ee(t[3],Y.readU32(e,r+12),ue,13,ce)]}function br(t,e,r,n){var o,i;if(i=n,n>=16){for(o=[t+ce+ue,t+ue,t,t-ce];n>=16;)o=yr(o,e,r),r+=16,n-=16;o=Ue(o[0],1)+Ue(o[1],7)+Ue(o[2],12)+Ue(o[3],18)+i}else o=t+Dt+n>>>0;for(;n>=4;)o=vr(o,e,r),r+=4,n-=4;for(;n>0;)o=_r(o,e,r),r++,n--;return o=He(Y.imul(He(Y.imul(He(o,15),ue),13),St),16),o>>>0}kt.hash=br;(function(t){var e=kt,r=he,n=4,o=13,i=5,c=6,d=65536,p=4,v=(1<<p)-1,T=4,b=(1<<T)-1,F=Qe(5<<20),Q=ge(),y=407708164,D=4,K=8,H=16,z=64,me=192,J=2147483648,Ae=7,ye=4,Be=7,ee={4:65536,5:262144,6:1048576,7:4194304};function ge(){try{return new Uint32Array(d)}catch{for(var L=new Array(d),_=0;_<d;_++)L[_]=0;return L}}function Fe(L){for(var _=0;_<d;_++)Q[_]=0}function Qe(L){try{return new Uint8Array(L)}catch{for(var _=new Array(L),m=0;m<L;m++)_[m]=0;return _}}function te(L,_,m){if(typeof L.buffer!==void 0){if(Uint8Array.prototype.slice)return L.slice(_,m);var h=L.length;_=_|0,_=_<0?Math.max(h+_,0):Math.min(_,h),m=m===void 0?h:m|0,m=m<0?Math.max(h+m,0):Math.min(m,h);for(var B=new Uint8Array(m-_),A=_,S=0;A<m;)B[S++]=L[A++];return B}else return L.slice(_,m)}t.compressBound=function(_){return _+_/255+16|0},t.decompressBound=function(_){var m=0;if(r.readU32(_,m)!==y)throw new Error("invalid magic number");m+=4;var h=_[m++];if((h&me)!==z)throw new Error("incompatible descriptor version "+(h&me));var B=(h&H)!==0,A=(h&K)!==0,S=_[m++]>>ye&Be;if(ee[S]===void 0)throw new Error("invalid block size "+S);var E=ee[S];if(A)return r.readU64(_,m);m++;for(var $=0;;){var M=r.readU32(_,m);if(m+=4,M&J?(M&=~J,$+=M):$+=E,M===0)return $;B&&(m+=4),m+=M}},t.makeBuffer=Qe,t.decompressBlock=function(_,m,h,B,A){var S,E,$,M,q;for($=h+B;h<$;){var V=_[h++],O=V>>4;if(O>0){if(O===15)for(;O+=_[h],_[h++]===255;);for(M=h+O;h<M;)m[A++]=_[h++]}if(h>=$)break;if(S=V&15,E=_[h++]|_[h++]<<8,S===15)for(;S+=_[h],_[h++]===255;);for(S+=n,q=A-E,M=q+S;q<M;)m[A++]=m[q++]|0}return A},t.compressBlock=function(_,m,h,B,A){var S,E,$,M,q,V,O,oe,G;if(O=0,oe=B+h,E=h,B>=o)for(var Z=(1<<c)+3;h+n<oe-i;){var Ie=r.readU32(_,h),re=r.hashU32(Ie)>>>0;if(re=(re>>16^re)>>>0&65535,S=A[re]-1,A[re]=h+1,S<0||h-S>>>16>0||r.readU32(_,S)!==Ie){q=Z++>>c,h+=q;continue}for(Z=(1<<c)+3,V=h-E,M=h-S,h+=n,S+=n,$=h;h<oe-i&&_[h]===_[S];)h++,S++;$=h-$;var Le=$<v?$:v;if(V>=b){for(m[O++]=(b<<p)+Le,G=V-b;G>=255;G-=255)m[O++]=255;m[O++]=G}else m[O++]=(V<<p)+Le;for(var be=0;be<V;be++)m[O++]=_[E+be];if(m[O++]=M,m[O++]=M>>8,$>=v){for(G=$-v;G>=255;G-=255)m[O++]=255;m[O++]=G}E=h}if(E===0)return 0;if(V=oe-E,V>=b){for(m[O++]=b<<p,G=V-b;G>=255;G-=255)m[O++]=255;m[O++]=G}else m[O++]=V<<p;for(h=E;h<oe;)m[O++]=_[h++];return O},t.decompressFrame=function(_,m){var h,B,A,S,E=0,$=0;if(r.readU32(_,E)!==y)throw new Error("invalid magic number");if(E+=4,S=_[E++],(S&me)!==z)throw new Error("incompatible descriptor version");h=(S&H)!==0,B=(S&D)!==0,A=(S&K)!==0;var M=_[E++]>>ye&Be;if(ee[M]===void 0)throw new Error("invalid block size");for(A&&(E+=8),E++;;){var q;if(q=r.readU32(_,E),E+=4,q===0)break;if(h&&(E+=4),q&J){q&=~J;for(var V=0;V<q;V++)m[$++]=_[E++]}else $=t.decompressBlock(_,m,E,q,$),E+=q}return B&&(E+=4),$},t.compressFrame=function(_,m){var h=0;r.writeU32(m,h,y),h+=4,m[h++]=z,m[h++]=Ae<<ye,m[h]=e.hash(0,m,4,h-4)>>8,h++;var B=ee[Ae],A=_.length,S=0;for(Fe();A>0;){var E=0,$=A>B?B:A;if(E=t.compressBlock(_,F,S,$,Q),E>$||E===0){r.writeU32(m,h,2147483648|$),h+=4;for(var M=S+$;S<M;)m[h++]=_[S++];A-=$}else{r.writeU32(m,h,E),h+=4;for(var q=0;q<E;)m[h++]=F[q++];S+=$,A-=$}}return r.writeU32(m,h,0),h+=4,h},t.decompress=function(_,m){var h,B;return m===void 0&&(m=t.decompressBound(_)),h=t.makeBuffer(m),B=t.decompressFrame(_,h),B!==m&&(h=te(h,0,B)),h},t.compress=function(_,m){var h,B;return m===void 0&&(m=t.compressBound(_.length)),h=t.makeBuffer(m),B=t.compressFrame(_,h),B!==m&&(h=te(h,0,B)),h}})(Tt);const lt=dr(Tt);class $t{constructor(e,r){this.high=e,this.low=r}}class At{constructor(e){this._data=e||new Uint8Array(0),this._view=null,this.position=0}get data(){return this._data}get dataView(){return this._view||(this._view=new DataView(this._data.buffer,this._data.byteOffset,this._data.byteLength))}reset(e){this._data=e,this.position=0,this._view=null}validate(e){return this.position+e>this._data.length?(console.error("read eof"),!1):!0}readUInt8(){if(this.validate(1))return this._data[this.position++]}readInt16(){return this.validate(2)?(this._data[this.position++]|this._data[this.position++]<<8)<<16>>16:void 0}readInt32(){return this.validate(4)?this._data[this.position++]|this._data[this.position++]<<8|this._data[this.position++]<<16|this._data[this.position++]<<24|0:void 0}readInt64(){const e=this.readInt32();if(e===void 0)return;let r=e;r<0&&(r+=4294967296);const n=this.readInt32();if(n!==void 0)return r+4294967296*n}readFloat32(){if(!this.validate(4))return;const e=this.dataView.getFloat32(this.position,!0);return this.position+=4,e}readFloat64(){if(!this.validate(8))return;const e=this.dataView.getFloat64(this.position,!0);return this.position+=8,e}read7BitInt(){let e=0,r=0,n=0,o=0;do{if(o++===35)throw new Error("Format_Bad7BitInt32");n=this.readUInt8(),e|=(n&127)<<r,r+=7}while(n&128);return e>>>0}readUTF(){const e=this.read7BitInt();return this.readUTFBytes(e)}readUint8Array(e,r=!1){const n=this.position,o=n+e,i=r?this._data.slice(n,o):this._data.subarray(n,o);return this.position=o,i}readUTFBytes(e){if(e===0)return"";if(!this.validate(e))return;const r=new TextDecoder("utf8").decode(this._data.subarray(this.position,this.position+e));return this.position+=e,r}}let ne=new Uint8Array(524288);class Bt{constructor(){this.position=0,this._view=null,this.data=ne}get dataView(){return this._view||(this._view=new DataView(this.data.buffer,0,this.data.byteLength))}reset(){this.data=ne,this._view=null,this.position=0}ensureBuffer(e){if(this.position+e<=ne.byteLength)return;const r=ne,n=this.position+e,o=Math.max(Math.floor(ne.byteLength*12/10),n);ne=new Uint8Array(o),ne.set(r,0),this.data=ne,this._view=null}writeInt8(e){this.ensureBuffer(1),this.data[this.position++]=e|0}writeInt16(e){this.ensureBuffer(2),this.data[this.position++]=e|0,this.data[this.position++]=e>>8&255}writeInt32(e){this.ensureBuffer(4),this.data[this.position++]=e|0,this.data[this.position++]=e>>8&255,this.data[this.position++]=e>>16&255,this.data[this.position++]=e>>24&255}writeInt64(e){this.writeInt32(e),e<0?this.writeInt32(~Math.floor(-e/4294967296)):this.writeInt32(Math.floor(e/4294967296)|0)}writeFloat32(e){this.ensureBuffer(4),this.dataView.setFloat32(this.position,e,!0),this.position+=4}writeFloat64(e){this.ensureBuffer(8),this.dataView.setFloat64(this.position,e,!0),this.position+=8}_write7BitInt(e){let r=e>>>0;for(;r>=128;)this.data[this.position++]=r&255|128,r>>>=7;this.data[this.position++]=r&127}write7BitInt(e){this.ensureBuffer(5),this._write7BitInt(e)}_7BitIntLen(e){return e<0?5:e<128?1:e<16384?2:e<2097152?3:e<268435456?4:5}writeUTF(e){const r=e.length;if(r===0){this.write7BitInt(0);return}const n=6*r;this.ensureBuffer(5+n);const o=this.position;this.position+=this._7BitIntLen(n);const i=this.position,c=i-o,d=new TextEncoder,{written:p}=d.encodeInto(e,this.data.subarray(this.position));this.position+=p;const v=this.position,T=v-i;this.position=o,this._write7BitInt(T);const b=this.position-o;b!==c&&this.data.copyWithin(i+(b-c),i,v),this.position=i+T+(b-c)}writeUint8Array(e,r=0,n){const o=r|0,i=Math.min(e.byteLength,o+(n??e.byteLength)),c=i-o;c<=0||(this.ensureBuffer(c),this.data.set(e.subarray(o,i),this.position),this.position+=c)}writeUTFBytes(e){this.ensureBuffer(6*e.length);const r=new TextEncoder,{written:n}=r.encodeInto(e,this.data.subarray(this.position));this.position+=n}getBytes(e=!1){return e?this.data.slice(0,this.position):this.data.subarray(0,this.position)}}class It{constructor(){this.dw=new Bt,this.strMap=new Map}reset(){this.dw.reset(),this.strMap.clear()}encodeInt(e){this.dw.writeInt8(1),this.dw.writeInt32(e|0)}encodeLong(e){this.dw.writeInt8(2),typeof e=="number"?this.dw.writeInt64(e):(this.dw.writeInt32(e.low|0),this.dw.writeInt32(e.high|0))}encodeFloat(e){this.dw.writeInt8(3),this.dw.writeFloat32(e)}encodeDouble(e){this.dw.writeInt8(4),this.dw.writeFloat64(e)}encodeNumber(e){(e|0)===e?this.encodeInt(e):Math.floor(e)===e?this.encodeLong(e):this.encodeDouble(e)}encodeString(e){const r=this.strMap.get(e);if(r!==void 0){this.dw.writeInt8(99),this.dw.write7BitInt(r);return}this.dw.writeInt8(5),this.dw.writeUTF(e),this.strMap.set(e,this.strMap.size)}encodeBoolean(e){this.dw.writeInt8(6),this.dw.writeInt8(e?1:0)}encodeNull(){this.dw.writeInt8(0)}encodeDateTime(e){this.dw.writeInt8(10),this.dw.writeInt64(e.getTime())}encodeBinary(e){this.dw.writeInt8(7),this.dw.write7BitInt(e.byteLength),this.dw.writeUint8Array(e)}encodeArray(e){this.dw.writeInt8(9),this.dw.write7BitInt(e.length);for(let r=0;r<e.length;r++)this.encode(e[r])}encodeMap(e){this.dw.writeInt8(8),this.dw.write7BitInt(e.size),e.forEach((r,n)=>{this.encode(n),this.encode(r)})}encodeObject(e){this.dw.writeInt8(8);const r=[];for(const n in e){if(!Object.prototype.hasOwnProperty.call(e,n)||n.startsWith("_"))continue;const o=typeof e[n];o==="function"||o==="undefined"||r.push(n)}this.dw.write7BitInt(r.length);for(const n of r)this.encode(n),this.encode(e[n])}encode(e){if(e==null){this.encodeNull();return}switch(e.constructor){case Number:this.encodeNumber(e);return;case Boolean:this.encodeBoolean(e);return;case String:this.encodeString(e);return;case $t:this.encodeLong(e);return;case Array:this.encodeArray(e);return;case Map:this.encodeMap(e);return;case Date:this.encodeDateTime(e);return;case Uint8Array:this.encodeBinary(e);return;default:if(typeof e!="object"){this.encodeNull();return}this.encodeObject(e);return}}getBytes(e=!1){return this.dw.getBytes(e)}}class Lt{constructor(){this.dr=new At(new Uint8Array(0)),this.strArr=[]}reset(e){this.dr.reset(e),this.strArr.length=0}decode(){switch(this.dr.readUInt8()){default:return null;case 1:return this.dr.readInt32();case 2:return this.dr.readInt64();case 3:return this.dr.readFloat32();case 4:return this.dr.readFloat64();case 5:{const r=this.dr.readUTF();return this.strArr.push(r),r}case 6:return this.dr.readUInt8()===1;case 7:{const r=this.dr.read7BitInt();return this.dr.readUint8Array(r,!1)}case 8:{const r=this.dr.read7BitInt(),n={};for(let o=0;o<r;o++){const i=this.decode(),c=this.decode();n[i]=c}return n}case 9:{const r=this.dr.read7BitInt(),n=new Array(r);for(let o=0;o<r;o++)n[o]=this.decode();return n}case 10:return new Date(this.dr.readInt64());case 99:return this.strArr[this.dr.read7BitInt()]}}}const Xe=new It,dt=new Lt,de={encode:(t,e=!0)=>(Xe.reset(),Xe.encode(t),Xe.getBytes(e)),decode:t=>(dt.reset(t),dt.decode())};class Ot{constructor(e){e!=null&&e.cmd&&(e.cmd=e.cmd.toLowerCase()),this._raw=e,this._rawData=void 0,this._data=void 0,this._t=void 0,this._sendMsg=void 0,this.rtt=0}get sendMsg(){return this._sendMsg}get seq(){return this._raw.seq}get resp(){return this._raw.resp}get ack(){return this._raw.ack}get cmd(){var e,r;return((e=this._raw)==null?void 0:e.cmd)&&((r=this._raw)==null?void 0:r.cmd.toLowerCase())}get code(){return~~this._raw.code}get error(){return this._raw.error}get time(){return this._raw.time}get body(){return this._raw.body}get rawData(){return this._rawData!==void 0||this.body===void 0?this._rawData:(this._rawData=de.decode(this.body),this._rawData)}setDataType(e){return e&&(this._t={name:e.name??"Anonymous",ctor:e}),this}setSendMsg(e){return this._sendMsg=e,this.setDataType(e.respType)}getData(e){if(this._data!==void 0||this.rawData===void 0)return this._data;let r=this._t;return e&&r&&e!==r.ctor&&(console.warn(`getData type not match, ${e.name} != ${r.name}`),r={name:e.name,ctor:e}),this._data=this.rawData,this._data}toLogString(){const e={...this._raw};return delete e.body,e.data=this.rawData,e.rtt=this.rtt,JSON.stringify(e)}}const Ct=new Map,Tr={encrypt:t=>{let e=lt.compress(t);const r=2+~~(Math.random()*248);for(let n=Math.min(e.length,100);--n>=0;)e[n]^=r;return e[0]=112,e[1]=108,e[2]=e[2]&170|(r>>7&1)<<6|(r>>6&1)<<4|(r>>5&1)<<2|r>>4&1,e[3]=e[3]&170|(r>>3&1)<<6|(r>>2&1)<<4|(r>>1&1)<<2|r&1,e},decrypt:t=>{const e=(t[2]>>6&1)<<7|(t[2]>>4&1)<<6|(t[2]>>2&1)<<5|(t[2]&1)<<4|(t[3]>>6&1)<<3|(t[3]>>4&1)<<2|(t[3]>>2&1)<<1|t[3]&1;for(let r=Math.min(100,t.length);--r>=2;)t[r]^=e;return t[0]=4,t[1]=34,t[2]=77,t[3]=24,lt.decompress(t)}},kr={encrypt:t=>{const e=~~(Math.random()*4294967295)>>>0,r=new Uint8Array(t.length+4);r[0]=e&255,r[1]=e>>>8&255,r[2]=e>>>16&255,r[3]=e>>>24&255,r.set(t,4);const n=2+~~(Math.random()*248);for(let o=r.length;--o>=0;)r[o]^=n;return r[0]=112,r[1]=120,r[2]=r[2]&170|(n>>7&1)<<6|(n>>6&1)<<4|(n>>5&1)<<2|n>>4&1,r[3]=r[3]&170|(n>>3&1)<<6|(n>>2&1)<<4|(n>>1&1)<<2|n&1,r},decrypt:t=>{const e=(t[2]>>6&1)<<7|(t[2]>>4&1)<<6|(t[2]>>2&1)<<5|(t[2]&1)<<4|(t[3]>>6&1)<<3|(t[3]>>4&1)<<2|(t[3]>>2&1)<<1|t[3]&1;for(let r=t.length;--r>=4;)t[r]^=e;return t.subarray(4)}},Sr={encrypt:t=>globalThis.XXTEA?globalThis.XXTEA.encryptMod({data:t.buffer,length:t.length}):t,decrypt:t=>globalThis.XXTEA?globalThis.XXTEA.decryptMod({data:t.buffer,length:t.length}):t};function st(t,e){Ct.set(t,e)}st("lx",Tr);st("x",kr);st("xtm",Sr);const Dr={encrypt:t=>se("x").encrypt(t),decrypt:t=>(t.length>4&&t[0]===112&&t[1]===108?t=se("lx").decrypt(t):t.length>4&&t[0]===112&&t[1]===120?t=se("x").decrypt(t):t.length>3&&t[0]===112&&t[1]===116&&(t=se("xtm").decrypt(t)),t)};function se(t){return Ct.get(t)??Dr}function Mt(t,e){let r=de.encode(t,!1);const n=e.encrypt(r);return n.buffer.byteLength===n.length?n.buffer:n.buffer.slice(0,n.length)}function Pt(t,e){const r=new Uint8Array(t),n=e.decrypt(r),o=de.decode(n);return new Ot(o)}const Ve={getEnc:se,encode:(t,e="x")=>Mt(t,se(e)),parse:(t,e="auto")=>Pt(t,se(e)),bon:de};de.encode,de.decode;const kn=Object.freeze(Object.defineProperty({__proto__:null,BonDecoder:Lt,BonEncoder:It,DataReader:At,DataWriter:Bt,Int64:$t,ProtoMsg:Ot,bon:de,encode:Mt,g_utils:Ve,getEnc:se,parse:Pt},Symbol.toStringTag,{value:"Module"})),j={ERROR:0,WARN:1,INFO:2,DEBUG:3,VERBOSE:4};class Er{constructor(e="APP"){this.namespace=e,this.level=this.getLogLevel(),this.isDev=!1,this.enableVerbose=localStorage.getItem("ws_debug_verbose")==="true"}getLogLevel(){return j.WARN}setLevel(e){this.level=e,localStorage.setItem("ws_debug_level",e.toString())}setVerbose(e){this.enableVerbose=e,localStorage.setItem("ws_debug_verbose",e.toString())}formatMessage(e,r,...n){const o=new Date().toLocaleTimeString("zh-CN",{hour12:!1,millisecond:!0}),i=Object.keys(j)[e];return[`[${o}] [${this.namespace}] [${i}]`,r,...n]}error(e,...r){this.level>=j.ERROR&&console.error(...this.formatMessage(j.ERROR,e,...r))}warn(e,...r){this.level>=j.WARN&&console.warn(...this.formatMessage(j.WARN,e,...r))}info(e,...r){this.level>=j.INFO&&console.info(...this.formatMessage(j.INFO,e,...r))}debug(e,...r){this.level>=j.DEBUG&&console.log(...this.formatMessage(j.DEBUG,e,...r))}verbose(e,...r){this.enableVerbose&&this.level>=j.VERBOSE&&console.log(...this.formatMessage(j.VERBOSE,e,...r))}wsConnect(e){this.info(`ğŸ”— WebSocketè¿æ¥: ${e}`)}wsDisconnect(e,r=""){this.info(`ğŸ”Œ WebSocketæ–­å¼€: ${e}${r?" - "+r:""}`)}wsError(e,r){this.error(`âŒ WebSocketé”™è¯¯ [${e}]:`,r)}wsMessage(e,r,n=!1){if(r==="_sys/ack")return;const o=n?"ğŸ“¨":"ğŸ“¤";this.debug(`${o} [${e}] ${r}`)}wsStatus(e,r,n=""){this.info(`ğŸ“Š [${e}] ${r}${n?" - "+n:""}`)}connectionLock(e,r,n=!0){n?this.debug(`ğŸ” è·å–è¿æ¥é”: ${e} (${r})`):this.debug(`ğŸ”“ é‡Šæ”¾è¿æ¥é”: ${e} (${r})`)}gameMessage(e,r,n=!1){r!=="_sys/ack"&&this.debug(`ğŸ® [${e}] ${r}${n?" âœ“":" âœ—"}`)}}const ot=t=>new Er(t),l=ot("WS"),qe=ot("TOKEN"),w=ot("GAME"),Se=t=>{l.setLevel(t),qe.setLevel(t),w.setLevel(t)},ft=(t=!0)=>{l.setVerbose(t),qe.setVerbose(t),w.setVerbose(t)};window.wsDebug={setLevel:Se,enableVerbose:ft,levels:j,quiet:()=>Se(j.WARN),normal:()=>Se(j.INFO),debug:()=>Se(j.DEBUG),verbose:()=>{Se(j.VERBOSE),ft(!0)}};console.info("ğŸ”§ WebSocketè°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œä½¿ç”¨ wsDebug.verbose() å¯ç”¨è¯¦ç»†æ—¥å¿—");const $r=t=>new Promise(e=>setTimeout(e,t)),Ar=t=>{if(!t)return"";if(t instanceof Uint8Array)return`[BON:${t.length}b]`;if(Array.isArray(t))return`[Array:${t.length}]`;if(typeof t=="object"){if(Object.keys(t).every(r=>!Number.isNaN(parseInt(r))))return`[BON:Object:${Object.keys(t).length}]`;try{return JSON.stringify(t)}catch{return"[Object]"}}return String(t)};class Br{constructor(e,r){this.encoder=e,this.enc=r,this.commands=new Map}register(e,r={}){return this.commands.set(e,(n=0,o=0,i={})=>{var c,d;return{cmd:e,ack:n,seq:o,time:Date.now(),body:(d=(c=this.encoder)==null?void 0:c.bon)!=null&&d.encode?this.encoder.bon.encode({...r,...i}):{...r,...i}}}),this}registerHeartbeat(){return this.commands.set("heart_beat",(e,r)=>({cmd:"_sys/ack",ack:e,seq:r,time:Date.now(),body:{}})),this}encodePacket(e){var r;return(r=this.encoder)!=null&&r.encode&&this.enc?this.encoder.encode(e,this.enc):JSON.stringify(e)}build(e,r,n,o){const i=this.commands.get(e);if(!i)throw new Error(`Unknown cmd: ${e}`);return i(r,n,o)}}function Ir(t){const e=t.registerHeartbeat().register("role_getroleinfo",{clientVersion:"2.10.3-f10a39eaa0c409f4-wx",inviteUid:0,platform:"hortor",platformExt:"mix",scene:""}).register("system_getdatabundlever",{isAudit:!1}).register("system_buygold",{buyNum:1}).register("system_claimhangupreward").register("system_signinreward").register("system_mysharecallback",{isSkipShareCard:!0,type:2}).register("system_custom",{key:"",value:0}).register("task_claimdailypoint",{taskId:1}).register("task_claimdailyreward",{rewardId:0}).register("task_claimweekreward",{rewardId:0}).register("friend_batch",{friendId:0}).register("hero_recruit",{byClub:!1,recruitNumber:1,recruitType:3}).register("item_openbox",{itemId:2001,number:10}).register("item_batchclaimboxpointreward").register("item_openpack").register("arena_startarea").register("fight_startlevel").register("arena_getareatarget",{refresh:!1}).register("arena_getarearank").register("store_goodslist",{storeId:1}).register("store_buy",{goodsId:1}).register("store_purchase",{goodsId:1}).register("store_refresh",{storeId:1}).register("legion_getinfo").register("legion_signin").register("legion_getwarrank").register("legionwar_getdetails").register("legion_storebuygoods").register("legion_kickout").register("legion_applylist").register("legion_approveapply").register("legion_refuseapply").register("legion_agree").register("legion_ignore").register("legion_getinfobyid").register("legion_getarearank").register("saltroad_getsaltroadwartotalrank").register("legionwar_getgoldmonthwarrank").register("legion_getopponent").register("legion_getbattlefield").register("mail_getlist",{category:[0,4,5],lastId:0,size:60}).register("mail_claimallattachment",{category:0}).register("mail_getmtlinfo").register("mail_getmtlshortinfo").register("study_startgame").register("study_answer").register("study_claimreward",{rewardId:1}).register("fight_starttower").register("fight_startboss").register("fight_startlegionboss").register("fight_startdungeon").register("fight_startpvp").register("evotower_getinfo").register("evotower_fight").register("evotower_getlegionjoinmembers").register("evotower_readyfight").register("evotower_claimreward").register("mergebox_getinfo").register("mergebox_claimfreeenergy").register("bottlehelper_claim").register("bottlehelper_start",{bottleType:-1}).register("bottlehelper_stop",{bottleType:-1}).register("legionmatch_rolesignup").register("legion_signin").register("artifact_lottery",{lotteryNumber:1,newFree:!0,type:1}).register("genie_sweep",{genieId:1}).register("genie_buysweep").register("discount_claimreward",{discountId:1}).register("collection_claimfreereward").register("card_claimreward",{cardId:1}).register("tower_getinfo").register("tower_claimreward").register("presetteam_getinfo").register("presetteam_getinfo").register("presetteam_setteam").register("presetteam_saveteam",{teamId:1}).register("role_gettargetteam").register("hero_heroupgradelevel").register("hero_heroupgradeorder").register("hero_heroupgradestar").register("book_upgrade").register("book_claimpointreward").register("rank_getroleinfo").register("nightmare_getroleinfo").register("dungeon_selecthero").register("bosstower_gethelprank").register("dungeon_buymerchant").register("activity_get").register("activity_recyclewarorderrewardclaim").register("legion_getpayloadtask").register("legion_getpayloadkillrecord").register("legion_getpayloadbf").register("legion_getpayloadrecord").register("collection_claimfreereward").register("collection_goodslist").register("car_getrolecar").register("car_refresh",{carId:0}).register("car_claim",{carId:0}).register("car_send",{carId:0,helperId:0,text:""}).register("car_getmemberhelpingcnt").register("car_getmemberrank").register("car_research").register("legacy_getinfo").register("legacy_claimhangup").register("legacy_gift_getlist").register("legacy_gift_send",{recipientId:0,itemId:0,quantity:0}).register("legacy_gift_received").register("role_commitpassword",{password:"",passwordType:1}).register("legacy_sendgift",{itemCnt:0,legacyUIds:[],targetId:0}).register("equipment_confirm",{heroId:0,part:0,quenchId:0,quenches:{}}).register("equipment_quench",{heroId:0,part:0,quenchId:0,quenches:{},seed:0,skipOrange:!1}).register("equipment_updatequenchlock",{heroId:0,part:0,slot:0,isLocked:!1}).register("matchteam_getroleteaminfo").register("bosstower_getinfo").register("bosstower_startboss").register("bosstower_startbox").register("discount_getdiscountinfo");return e.commands.set("fight_startareaarena",(r=0,n=0,o={})=>{var d,p;if((o==null?void 0:o.targetId)===void 0||(o==null?void 0:o.targetId)===null)throw new Error("fight_startareaarena requires targetId in params");const i={...o},c=(p=(d=e.encoder)==null?void 0:d.bon)!=null&&p.encode?e.encoder.bon.encode(i):i;return{cmd:"fight_startareaarena",ack:r,seq:n,time:Date.now(),body:c}}),e.commands.set("fight_startpvp",(r=0,n=0,o={})=>{var d,p;const i={...o},c=(p=(d=e.encoder)==null?void 0:d.bon)!=null&&p.encode?e.encoder.bon.encode(i):i;return{cmd:"fight_startpvp",ack:r,seq:n,time:Date.now(),body:c}}),e}class Lr{constructor({url:e,utils:r,heartbeatMs:n=5e3}){var o;this.url=e,this.utils=r||Ve,this.enc=(o=this.utils)!=null&&o.getEnc?this.utils.getEnc("auto"):void 0,this.socket=null,this.ack=0,this.seq=0,this.sendQueue=[],this.sendQueueTimer=null,this.heartbeatTimer=null,this.heartbeatInterval=n,this.dialogStatus=!1,this.messageListener=null,this.showMsg=!1,this.connected=!1,this.isReconnecting=!1,this.promises=Object.create(null),this.registry=Ir(new Br(this.utils,this.enc)),this.onConnect=null,this.onDisconnect=null,this.onError=null}init(){l.info(`è¿æ¥: ${this.url.split("?")[0]}`),this.socket=new WebSocket(this.url),this.socket.onopen=()=>{l.info("è¿æ¥æˆåŠŸ"),this.connected=!0,this._setupHeartbeat(),this._processQueueLoop(),this.onConnect&&this.onConnect()},this.socket.onmessage=e=>{var r;try{let n;if(typeof e.data=="string")n=JSON.parse(e.data);else if(e.data instanceof ArrayBuffer)n=(r=this.utils)!=null&&r.parse?this.utils.parse(e.data,"auto"):e.data;else if(e.data instanceof Blob){e.data.arrayBuffer().then(o=>{var i;try{if(n=(i=this.utils)!=null&&i.parse?this.utils.parse(o,"auto"):o,n instanceof Object&&n.rawData!==void 0)w.verbose("ProtoMsg Blobæ¶ˆæ¯ï¼Œä½¿ç”¨rawData:",n.rawData);else if(n.body&&this.shouldDecodeBody(n.body))try{if(this.utils&&this.utils.bon&&this.utils.bon.decode){const p=this.convertToUint8Array(n.body);if(p){const v=this.utils.bon.decode(p);w.debug("BON Blobè§£ç æˆåŠŸ:",n.cmd,v),n.decodedBody=v}}else w.warn("BONè§£ç å™¨ä¸å¯ç”¨ (Blob)")}catch(p){w.error("BON Blobæ¶ˆæ¯ä½“è§£ç å¤±è´¥:",p.message,n.cmd)}const c=n._raw||n,d=typeof(c==null?void 0:c.seq)=="number"?c.seq:typeof(n==null?void 0:n.seq)=="number"?n.seq:void 0;typeof d=="number"&&d>=0&&(this.ack=d),this.showMsg,this.messageListener&&this.messageListener(n),this._handlePromiseResponse(n)}catch(c){w.error("Blobè§£æå¤±è´¥:",c.message)}});return}else w.warn("æœªçŸ¥æ•°æ®ç±»å‹:",typeof e.data,e.data),n=e.data;if(this.showMsg&&w.verbose("æ”¶åˆ°æ¶ˆæ¯:",n),n instanceof Object&&n.rawData!==void 0)w.verbose("ProtoMsgæ¶ˆæ¯ï¼Œä½¿ç”¨rawData:",n.rawData);else{const o=n._raw||n,i=typeof o.seq=="number"?o.seq:typeof n.seq=="number"?n.seq:void 0;if(typeof i=="number"&&i>=0&&(this.ack=i),o.body&&this.shouldDecodeBody(o.body))try{if(this.utils&&this.utils.bon&&this.utils.bon.decode){const c=this.convertToUint8Array(o.body);if(c){const d=this.utils.bon.decode(c);w.debug("BONè§£ç æˆåŠŸ:",o.cmd||n.cmd,d),n.decodedBody=d,n._raw&&(n._raw.decodedBody=d)}}else w.warn("BONè§£ç å™¨ä¸å¯ç”¨")}catch(c){w.error("BONæ¶ˆæ¯ä½“è§£ç å¤±è´¥:",c.message,o.cmd||n.cmd)}}this.messageListener&&this.messageListener(n),this._handlePromiseResponse(n)}catch(n){w.error("æ¶ˆæ¯å¤„ç†å¤±è´¥:",n.message)}},this.socket.onclose=e=>{l.info(`WebSocket è¿æ¥å…³é—­: ${e.code} ${e.reason||""}`),l.debug("å…³é—­è¯¦æƒ…:",{code:e.code,reason:e.reason||"æœªæä¾›åŸå› ",wasClean:e.wasClean,timestamp:new Date().toISOString()}),this.connected=!1,this._clearTimers(),this.onDisconnect&&this.onDisconnect(e)},this.socket.onerror=e=>{l.error("WebSocket é”™è¯¯:",e),this.connected=!1,this._clearTimers(),this.onError&&this.onError(e)}}setMessageListener(e){this.messageListener=e}setShowMsg(e){this.showMsg=!!e}shouldDecodeBody(e){if(!e)return!1;if(e instanceof Uint8Array||Array.isArray(e))return!0;if(typeof e=="object"&&e.constructor===Object){const r=Object.keys(e);return r.length>0&&r.every(n=>!isNaN(parseInt(n)))}return!1}convertToUint8Array(e){if(!e)return null;if(e instanceof Uint8Array)return e;if(Array.isArray(e))return new Uint8Array(e);if(typeof e=="object"&&e.constructor===Object){const r=Object.keys(e).map(n=>parseInt(n)).sort((n,o)=>n-o);if(r.length>0){const n=Math.max(...r),o=new Array(n+1).fill(0);for(const[i,c]of Object.entries(e)){const d=parseInt(i);!isNaN(d)&&typeof c=="number"&&(o[d]=c)}return w.debug("è½¬æ¢å¯¹è±¡æ ¼å¼bodyä¸ºUint8Array:",o.length,"bytes"),new Uint8Array(o)}}return null}decodeBodyForLog(e){var o,i;if(!e)return null;const r=(i=(o=this.utils)==null?void 0:o.bon)==null?void 0:i.decode;if(typeof r!="function")return null;let n=null;if(e instanceof Uint8Array?n=e:Array.isArray(e)?n=new Uint8Array(e):this.shouldDecodeBody(e)&&(n=this.convertToUint8Array(e)),!n)return null;try{return r(n)}catch(c){return w.warn("æ—¥å¿—è§£æBONå¤±è´¥:",c.message),null}}reconnect(){if(this.isReconnecting){l.debug("é‡è¿å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡æ­¤æ¬¡é‡è¿è¯·æ±‚");return}this.isReconnecting=!0,l.info("å¼€å§‹WebSocketé‡è¿..."),this.disconnect(),setTimeout(()=>{try{this.init()}finally{setTimeout(()=>{this.isReconnecting=!1},2e3)}},1e3)}disconnect(){this.socket&&(this.socket.close(),this.socket=null),this.connected=!1,this._clearTimers()}send(e,r={},n={}){this.connected||(l.warn(`WebSocket æœªè¿æ¥ï¼Œæ¶ˆæ¯å·²å…¥é˜Ÿ: ${e}`),!this.dialogStatus&&!this.isReconnecting&&(this.dialogStatus=!0,l.info("è‡ªåŠ¨è§¦å‘é‡è¿..."),this.reconnect(),setTimeout(()=>{this.dialogStatus=!1},2e3)));const o=n.seq!==void 0?n.seq:e==="heart_beat"?0:++this.seq,i={cmd:e,params:r,seq:o,respKey:n.respKey||e,sleep:n.sleep||0,onSent:n.onSent};return this.sendQueue.push(i),i}sendWithPromise(e,r={},n=5e3){return new Promise((o,i)=>{if(!this.connected&&!this.socket)return i(new Error("WebSocket è¿æ¥å·²å…³é—­"));const c=++this.seq;this.promises[c]={resolve:o,reject:i,originalCmd:e},setTimeout(()=>{delete this.promises[c],i(new Error(`è¯·æ±‚è¶…æ—¶: ${e} (${n}ms)`))},n),this.send(e,r,{seq:c,onSent:()=>{}})})}sendHeartbeat(){l.verbose("å‘é€å¿ƒè·³æ¶ˆæ¯"),this.send("heart_beat",{},{respKey:"_sys/ack"})}getRoleInfo(e={}){return this.sendWithPromise("role_getroleinfo",e)}getDataBundleVersion(e={}){return this.sendWithPromise("system_getdatabundlever",e)}signIn(){return this.sendWithPromise("system_signinreward")}claimDailyReward(e=0){return this.sendWithPromise("task_claimdailyreward",{rewardId:e})}_setupHeartbeat(){setTimeout(()=>{var e;this.connected&&((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&(l.debug("å¼€å§‹å‘é€é¦–æ¬¡å¿ƒè·³"),this.sendHeartbeat())},3e3),this.heartbeatTimer=setInterval(()=>{var e;this.connected&&((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN?this.sendHeartbeat():l.warn("å¿ƒè·³æ£€æŸ¥å¤±è´¥: è¿æ¥çŠ¶æ€å¼‚å¸¸")},this.heartbeatInterval)}_processQueueLoop(){this.sendQueueTimer&&clearInterval(this.sendQueueTimer),this.sendQueueTimer=setInterval(async()=>{var r,n;if(!this.sendQueue.length||!this.connected||((r=this.socket)==null?void 0:r.readyState)!==WebSocket.OPEN)return;const e=this.sendQueue.shift();if(e)try{const o=this.registry.build(e.cmd,this.ack,e.seq,e.params);if(o&&o.cmd!=="_sys/ack"){const c=this.decodeBodyForLog(o.body);l.info("ğŸ“¤ å‘é€æŠ¥æ–‡",{cmd:o.cmd,ack:o.ack??0,seq:o.seq??0,time:o.time,body:c??Ar(o.body)})}const i=this.registry.encodePacket(o);if((n=this.socket)==null||n.send(i),(this.showMsg||e.cmd==="heart_beat")&&(l.wsMessage("local",e.cmd,!1),this.showMsg&&(l.verbose("åŸå§‹æ•°æ®:",o),l.verbose("ç¼–ç åæ•°æ®:",i),l.verbose("ç¼–ç ç±»å‹:",typeof i,i instanceof Uint8Array?"Uint8Array (åŠ å¯†)":"String (æ˜æ–‡)"),i instanceof Uint8Array&&i.length>0&&l.verbose(`åŠ å¯†éªŒè¯: å‰8å­—èŠ‚ [${Array.from(i.slice(0,8)).join(", ")}]`))),e.onSent)try{const c={respKey:e.respKey,cmd:e.cmd,seq:(o==null?void 0:o.seq)??e.seq,ack:(o==null?void 0:o.ack)??this.ack,time:(o==null?void 0:o.time)??Date.now()};e.onSent(c)}catch(c){l.warn("å‘é€å›è°ƒæ‰§è¡Œå¤±è´¥:",c)}e.sleep&&await $r(e.sleep)}catch(o){l.error(`å‘é€æ¶ˆæ¯å¤±è´¥: ${e.cmd}`,o)}},50)}_handlePromiseResponse(e){if(e.resp!==void 0&&this.promises[e.resp]){const c=this.promises[e.resp];delete this.promises[e.resp];const d=e.rawData!==void 0?e.rawData:e.decodedBody!==void 0?e.decodedBody:e.body;if(e.code===0||e.code===void 0)c.resolve(d||e);else{const v={700010:"ä»»åŠ¡æœªè¾¾æˆå®Œæˆæ¡ä»¶",1400010:"æ²¡æœ‰è´­ä¹°è¯¥æœˆå¡,ä¸èƒ½é¢†å–æ¯æ—¥å¥–åŠ±",12000116:"ä»Šæ—¥å·²é¢†å–å…è´¹å¥–åŠ±",3300060:"æ‰«è¡æ¡ä»¶ä¸æ»¡è¶³",1300050:"è¯·ä¿®æ”¹æ‚¨çš„é‡‡è´­æ¬¡æ•°",200020:"å‡ºäº†ç‚¹å°é—®é¢˜ï¼Œè¯·å°è¯•é‡å¯æ¸¸æˆè§£å†³ï½",200160:"æ¨¡å—æœªå¼€å¯",7500140:"è¯·å…ˆè¾“å…¥å¯†ç ",7500100:"å¯†ç è¾“å…¥é”™è¯¯",7500120:"å¯†ç è¾“å…¥é”™è¯¯æ¬¡æ•°å·²è¾¾ä¸Šé™",200400:"æ“ä½œå¤ªå¿«ï¼Œè¯·ç¨åå†è¯•",200760:"æ‚¨å½“å‰çœ‹åˆ°çš„ç•Œé¢å·²å‘ç”Ÿå˜åŒ–ï¼Œè¯·é‡æ–°ç™»å½•",2300190:"æœªåŠ å…¥ä¿±ä¹éƒ¨",2300370:"ä¿±ä¹éƒ¨å•†å“è´­ä¹°æ•°é‡è¶…å‡ºä¸Šé™",4e5:"ç‰©å“ä¸å­˜åœ¨",1500020:"èƒ½é‡ä¸è¶³",2300070:"æœªåŠ å…¥ä¿±ä¹éƒ¨",3500020:"æ²¡æœ‰å¯é¢†å–çš„å¥–åŠ±"}[e.code]||e.hint||"æœªçŸ¥é”™è¯¯";c.reject(new Error(`æœåŠ¡å™¨é”™è¯¯: ${e.code} - ${v}`))}return}const r=e.cmd;if(!r)return;const n=typeof r=="string"?r.toLowerCase():r;let i={fight_startpvpresp:"fight_startpvp",activity_getresp:"activity_get",collection_goodslistresp:"collection_goodslist",collection_claimfreerewardresp:"collection_claimfreereward",legion_getarearankresp:"legion_getarearank",legionwar_getgoldmonthwarrankresp:"legionwar_getgoldmonthwarrank",nightmare_getroleinforesp:"nightmare_getroleinfo",studyresp:"study_startgame",role_getroleinforesp:"role_getroleinfo",hero_recruitresp:"hero_recruit",friend_batchresp:"friend_batch",system_claimhanguprewardresp:"system_claimhangupreward",item_openboxresp:["item_openbox","item_batchclaimboxpointreward"],bottlehelper_claimresp:"bottlehelper_claim",bottlehelper_startresp:"bottlehelper_start",bottlehelper_stopresp:"bottlehelper_stop",legion_signinresp:"legion_signin",fight_startbossresp:"fight_startboss",fight_startlegionbossresp:"fight_startlegionboss",fight_startareaarenaresp:"fight_startareaarena",arena_startarearesp:"arena_startarea",arena_getareatargetresp:"arena_getareatarget",arena_getarearankresp:"arena_getarearank",presetteam_saveteamresp:"presetteam_saveteam",presetteam_getinforesp:"presetteam_getinfo",mail_claimallattachmentresp:"mail_claimallattachment",store_buyresp:"store_purchase",system_getdatabundleverresp:"system_getdatabundlever",tower_claimrewardresp:"tower_claimreward",fight_starttowerresp:"fight_starttower",evotowerinforesp:"evotower_getinfo",evotower_fightresp:"evotower_fight",evotower_getlegionjoinmembersresp:"evotower_getlegionjoinmembers",mergebox_getinforesp:"mergebox_getinfo",mergebox_claimfreeenergyresp:"mergebox_claimfreeenergy",item_openpackresp:"item_openpack",equipment_quenchresp:"equipment_quench",matchteam_getroleteaminforesp:"matchteam_getroleteaminfo",bosstower_getinforesp:"bosstower_getinfo",bosstower_startbossreso:"bosstower_startboss",bosstower_startboxresp:"bosstower_startbox",discount_getdiscountinforesp:"discount_getdiscountinfo",hero_heroupgradestarresp:"hero_heroupgradestar",book_upgraderesp:"book_upgrade",book_claimpointrewardresp:"book_claimpointreward",legion_getinforesp:"legion_getinfo",legion_getinforresp:"legion_getinfo",car_getrolecarresp:"car_getrolecar",car_refreshresp:"car_refresh",car_claimresp:"car_claim",car_sendresp:"car_send",car_getmemberhelpingcntresp:"car_getmemberhelpingcnt",car_getmemberrankresp:"car_getmemberrank",role_gettargetteamresp:"role_gettargetteam",activity_warorderclaimresp:"activity_recyclewarorderrewardclaim",arena_getarearankresp:"arena_getarearank",bosstower_gethelprankresp:"bosstower_gethelprank",legacy_getinforesp:"legacy_getinfo",legacy_claimhangupresp:"legacy_claimhangup",legacy_sendgiftresp:"legacy_sendgift",legacy_getgiftsresp:"legacy_getgifts",task_claimdailyrewardresp:"task_claimdailyreward",task_claimweekrewardresp:"task_claimweekreward",syncresp:["system_mysharecallback","task_claimdailypoint","role_commitpassword"],syncrewardresp:["system_buygold","discount_claimreward","card_claimreward","artifact_lottery","genie_sweep","genie_buysweep","system_signinreward","dungeon_selecthero"]}[n];i?typeof i=="string"&&(i=[i]):i=[n];for(const[c,d]of Object.entries(this.promises))if(i.includes(d.originalCmd)){delete this.promises[c];const p=e.rawData!==void 0?e.rawData:e.decodedBody!==void 0?e.decodedBody:e.body;if(e.code===0||e.code===void 0)d.resolve(p||e);else{const T={700010:"ä»»åŠ¡æœªè¾¾æˆå®Œæˆæ¡ä»¶",1400010:"æ²¡æœ‰è´­ä¹°è¯¥æœˆå¡,ä¸èƒ½é¢†å–æ¯æ—¥å¥–åŠ±",12000116:"ä»Šæ—¥å·²é¢†å–å…è´¹å¥–åŠ±",3300060:"æ‰«è¡æ¡ä»¶ä¸æ»¡è¶³",1300050:"è¯·ä¿®æ”¹æ‚¨çš„é‡‡è´­æ¬¡æ•°",200020:"å‡ºäº†ç‚¹å°é—®é¢˜ï¼Œè¯·å°è¯•é‡å¯æ¸¸æˆè§£å†³ï½",200160:"æ¨¡å—æœªå¼€å¯",2300190:"æœªåŠ å…¥ä¿±ä¹éƒ¨",3500020:"æ²¡æœ‰å¯é¢†å–çš„å¥–åŠ±"}[e.code]||e.hint||"æœªçŸ¥é”™è¯¯";d.reject(new Error(`æœåŠ¡å™¨é”™è¯¯: ${e.code} - ${T}`))}break}}_clearTimers(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.sendQueueTimer&&(clearInterval(this.sendQueueTimer),this.sendQueueTimer=null)}}const Or=Object.prototype.hasOwnProperty;function Ne(){}Ne.prototype=Object.create(null);class Cr{constructor(e,r){this.fn=e,this.once=r||!1}}function ht(t,e,r,n){const o=new Cr(r,n),i=t._events[e];return i?i.fn?t._events[e]=[i,o]:i.push(o):(t._events[e]=o,t._eventsCount++),t}function xe(t,e){--t._eventsCount===0?t._events=new Ne:delete t._events[e]}class fe{constructor(){this._events=new Ne,this._eventsCount=0}eventNames(){let e=[],r,n;if(this._eventsCount===0)return e;for(n in r=this._events)Or.call(r,n)&&e.push(n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(r)):e}listeners(e,r){const n=this._events[e];if(r)return!!n;if(!n)return[];if(n.fn)return[n.fn];const o=new Array(n.length);for(let i=0;i<o.length;i++)o[i]=n[i].fn;return o}emit(e,r,n,o,i,c){const d=this._events[e];if(!d)return!1;let p=arguments.length,v,T,b;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,!0),p){case 1:return d.fn(),!0;case 2:return d.fn(r),!0;case 3:return d.fn(r,n),!0;case 4:return d.fn(r,n,o),!0;case 5:return d.fn(r,n,o,i),!0;case 6:return d.fn(r,n,o,i,c),!0}for(v=new Array(p-1),b=1;b<p;b++)v[b-1]=arguments[b];d.fn.apply(void 0,v)}else for(b=0;b<d.length;b++)switch(d[b].once&&this.removeListener(e,d[b].fn,!0),p){case 1:d[b].fn();break;case 2:d[b].fn(r);break;case 3:d[b].fn(r,n);break;case 4:d[b].fn(r,n,o);break;case 5:d[b].fn(r,n,o,i);break;case 6:d[b].fn(r,n,o,i,c);break;default:if(!v)for(v=new Array(p-1),T=1;T<p;T++)v[T-1]=arguments[T];d[b].fn.apply(void 0,v)}return!0}asyncEmit(e,r,n,o,i,c){return process.nextTick(()=>this.emit(...arguments)),!!this._events[e]}on(e,r){return ht(this,e,r,!1)}once(e,r){return ht(this,e,r,!0)}removeListener(e,r,n){const o=this._events[e];if(!o)return this;if(!r)return xe(this,e),this;if(o.fn)o.fn===r&&(!n||o.once)&&xe(this,e);else{const i=o.filter(c=>c.fn!==r||n&&!c.once);i.length?this._events[e]=i.length===1?i[0]:i:xe(this,e)}return this}removeAllListeners(e){return e?this._events[e]&&xe(this,e):(this._events=new Ne,this._eventsCount=0),this}setMaxListeners(){return this}}fe.prototype.off=fe.prototype.removeListener;fe.prototype.addListener=fe.prototype.on;fe.EventEmitter=fe;var Mr=fe;let Je=!1;const Pr=(async()=>{try{Je=!1;const e=await(await fetch("/answer.json")).json();return Je=!0,e}catch(t){return Je=!1,console.error("âŒ åŠ è½½ç­”é¢˜æ•°æ®å¤±è´¥:",t),[]}})();async function it(){return Pr}function Ur(t,e,r=1){if(!t||!e)return!1;if(r===1){const n=t.replace(/\s+/g,"").toLowerCase(),o=e.replace(/\s+/g,"").toLowerCase();return o.includes(n)||n.includes(o)}return!1}async function xr(t){try{const e=await it();if(!e||e.length===0)return null;for(let r=0;r<e.length;r++){const n=e[r];if(!(!n.name||!n.value)&&Ur(n.name,t,1))return n.value}return null}catch(e){return console.error("âŒ æŸ¥æ‰¾ç­”æ¡ˆæ—¶å‡ºé”™:",e),null}}async function Sn(){const t=await it();return t?t.length:0}async function Dn(){try{await it()}catch(t){console.error("âŒ ç­”é¢˜æ•°æ®é¢„åŠ è½½å¤±è´¥:",t)}}const Rr=(t,e=1)=>{Ge.locale("zh-cn",{week:{dow:1,doy:4}});const r=Ge(t),n=Ge();return r.isSame(n,"week")},qr=({onSome:t,$emit:e})=>{t(["study","studyresp","study_startgame","study_startgameresp"],async r=>{var p,v;w.verbose(`æ”¶åˆ°å­¦ä¹ ç­”é¢˜äº‹ä»¶: ${r.tokenId}`,r);const{body:n,gameData:o,client:i}=r;if(!n)return;w.info("å¼€å§‹å¤„ç†å­¦ä¹ ç­”é¢˜å“åº”");const c=n.questionList,d=(v=(p=n.role)==null?void 0:p.study)==null?void 0:v.id;if(!c||!Array.isArray(c)){w.error("æœªæ‰¾åˆ°é¢˜ç›®åˆ—è¡¨");return}if(!d){w.error("æœªæ‰¾åˆ°å­¦ä¹ ID");return}w.info(`æ‰¾åˆ° ${c.length} é“é¢˜ç›®ï¼Œå­¦ä¹ ID: ${d}`),o.value.studyStatus={isAnswering:!0,questionCount:c.length,answeredCount:0,status:"answering",timestamp:Date.now()};try{for(let T=0;T<c.length;T++){const b=c[T],F=b.question,Q=b.id;w.debug(`é¢˜ç›® ${T+1}: ${F.substring(0,20)}...`);let y=await xr(F);y===null?(y=1,w.verbose(`æœªæ‰¾åˆ°åŒ¹é…ç­”æ¡ˆï¼Œä½¿ç”¨é»˜è®¤ç­”æ¡ˆ: ${y}`)):w.debug(`æ‰¾åˆ°ç­”æ¡ˆ: ${y}`);try{i==null||i.send("study_answer",{id:d,option:[y],questionId:[Q]}),w.verbose(`å·²æäº¤é¢˜ç›® ${T+1} çš„ç­”æ¡ˆ: ${y}`)}catch(D){w.error(`æäº¤ç­”æ¡ˆå¤±è´¥ (é¢˜ç›® ${T+1}):`,D)}o.value.studyStatus.answeredCount=T+1,T<c.length-1&&await new Promise(D=>setTimeout(D,200))}await new Promise(T=>setTimeout(T,500)),e.emit("I-study-week-forward",r)}catch(T){w.error("å¤„ç†å­¦ä¹ ç­”é¢˜å“åº”å¤±è´¥:",T)}}),t(["I-study"],r=>{const{body:n,gameData:o}=r,i=n.role.study.maxCorrectNum,c=n.role.study.beginTime,d=i>=10&&Rr(c*1e3);o.value.studyStatus||(o.value.studyStatus={}),o.value.studyStatus.thisWeek=d,o.value.studyStatus.isCompleted=d,o.value.studyStatus.maxCorrectNum=i,w.info(`ç­”é¢˜çŠ¶æ€æ›´æ–°: maxCorrectNum=${i}, å®ŒæˆçŠ¶æ€=${d}`)}),t(["I-study-week-forward"],async r=>{w.info("å¼€å§‹é¢†å–ç­”é¢˜å¥–åŠ±");const{gameData:n,client:o}=r;n.value.studyStatus.status="claiming_rewards";for(let i=1;i<=10;i++)try{o==null||o.send("study_claimreward",{rewardId:i}),await new Promise(c=>setTimeout(c,200)),w.verbose(`å·²å‘é€å¥–åŠ±é¢†å–è¯·æ±‚: rewardId=${i}`)}catch(c){w.error(`å‘é€å¥–åŠ±é¢†å–è¯·æ±‚å¤±è´¥ (rewardId=${i}):`,c)}w.info("ä¸€é”®ç­”é¢˜å®Œæˆï¼å·²å°è¯•é¢†å–æ‰€æœ‰å¥–åŠ±"),n.value.studyStatus.status="completed",await new Promise(i=>setTimeout(i,3e3)),n.value.studyStatus={isAnswering:!1,questionCount:0,answeredCount:0,status:"",timestamp:null},await new Promise(i=>setTimeout(i,1e3));try{o==null||o.send("role_getroleinfo",{}),w.debug("å·²è¯·æ±‚æ›´æ–°è§’è‰²ä¿¡æ¯")}catch(i){w.error("è¯·æ±‚è§’è‰²ä¿¡æ¯æ›´æ–°å¤±è´¥:",i)}})},Nr=ve("xyzw_chat_msg_list",[]),_e=new Mr.EventEmitter,Vr=new Set,X=(t,e)=>{t.map(r=>Vr.add(r)),t.forEach(r=>{_e.on(r,e)})},Wr=(t,...e)=>{const r=_e.emit(t,...e);return _e.emit("$any",t,...e),r};_e.on("$any",(t,e)=>{w.debug(`æ”¶åˆ°æœªå¤„ç†äº‹ä»¶: ${t} TokenID: ${e.tokenId}`,e)});qr({onSome:X,$emit:_e});X(["_sys/ack"],t=>{});X(["legion_applylistresp"],t=>{w.debug(`æ”¶åˆ°ä¿±ä¹éƒ¨ç”³è¯·åˆ—è¡¨å“åº”: ${t.tokenId}`,t.body)});X(["system_newchatmessagenotify","system_newchatmessagenotifyresp"],t=>{w.debug(`æ”¶åˆ°æ–°èŠå¤©æ¶ˆæ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e,gameData:r}=t;if(!e||!e.chatMessage){w.debug("èŠå¤©æ¶ˆæ¯å“åº”ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");return}Nr.value.push(e.chatMessage)});X(["role_getroleinforesp","role_getroleinfo"],t=>{var i,c,d,p;w.verbose(`æ”¶åˆ°è§’è‰²ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e,tokenId:r}=t;t.gameData.value.roleInfo=e,t.gameData.value.lastUpdated=new Date().toISOString(),((c=(i=e.role)==null?void 0:i.study)==null?void 0:c.maxCorrectNum)!==void 0&&_e.emit("I-study",t);const n=Rt(),o=n.gameTokens.find(v=>v.id===r);if(o){const v=((d=e==null?void 0:e.role)==null?void 0:d.serverName)||(e==null?void 0:e.serverName)||((p=e==null?void 0:e.role)==null?void 0:p.server)||(e==null?void 0:e.server);v&&v!==o.server&&(n.updateToken(r,{server:v}),w.verbose(`å·²æ›´æ–°Token ${r} çš„æœåŠ¡å™¨ä¿¡æ¯`,{server:v}))}});X(["legion_getinfo","legion_getinforesp","legion_getinfor","legion_getinforresp"],t=>{w.verbose(`æ”¶åˆ°å†›å›¢ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e}=t;if(!e){w.debug("å†›å›¢ä¿¡æ¯å“åº”ä¸ºç©º");return}t.gameData.value.legionInfo=e,t.gameData.value.lastUpdated=new Date().toISOString()});X(["activity_getresp","activity_get"],t=>{w.verbose(`æ”¶åˆ°æ´»åŠ¨ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e}=t;if(w.debug("æ´»åŠ¨ä¿¡æ¯body:",e),!e){w.debug("æ´»åŠ¨ä¿¡æ¯å“åº”ä¸ºç©º");return}t.gameData.value.commonActivityInfo=e,t.gameData.value.lastUpdated=new Date().toISOString()});X(["bosstower_getinforesp","bosstower_getinfo"],t=>{w.verbose(`æ”¶åˆ°å’¸ç‹å®åº“ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e}=t;if(w.debug("å’¸ç‹å®åº“body:",e),!e){w.debug("å’¸ç‹å®åº“å“åº”ä¸ºç©º");return}t.gameData.value.bossTowerInfo=e,t.gameData.value.lastUpdated=new Date().toISOString()});X(["evotowerinforesp","evotower_getinforesp","evotower_getinfo"],t=>{w.verbose(`æ”¶åˆ°æ€ªå¼‚å¡”ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e}=t;if(w.debug("æ€ªå¼‚å¡”body:",e),!e){w.debug("æ€ªå¼‚å¡”å“åº”ä¸ºç©º");return}t.gameData.value.evoTowerInfo=e,t.gameData.value.lastUpdated=new Date().toISOString()});X(["team_getteaminfo","team_getteaminforesp","role_gettargetteam","role_gettargetteamresp"],t=>{w.verbose(`æ”¶åˆ°é˜Ÿä¼ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e,gameData:r,cmd:n}=t;if(!e){w.debug("é˜Ÿä¼ä¿¡æ¯å“åº”ä¸ºç©º");return}r.value.presetTeam||(r.value.presetTeam={}),r.value.presetTeam={...r.value.presetTeam,...e},t.gameData.value.lastUpdated=new Date().toISOString()});X(["presetteam_setteam","presetteam_setteamresp","presetteam_saveteam","presetteam_saveteamresp"],t=>{w.verbose(`æ”¶åˆ°é˜Ÿä¼ä¿¡æ¯äº‹ä»¶: ${t.tokenId}`,t);const{body:e,gameData:r,cmd:n}=t;if(!e){w.debug("é˜Ÿä¼ä¿¡æ¯å“åº”ä¸ºç©º");return}r.value.presetTeam||(r.value.presetTeam={}),e.presetTeamInfo&&(r.value.presetTeam.presetTeamInfo=e.presetTeamInfo),Object.keys(e).forEach(o=>{(o.includes("team")||o.includes("Team"))&&(r.value.presetTeam[o]=e[o])})});X(["tower_getinfo","tower_getinforesp"],t=>{w.verbose(`æ”¶åˆ°æŸ¥è¯¢å¡”äº‹ä»¶: ${t.tokenId}`,t);const{body:e,gameData:r,client:n}=t;if(r.value.towerResult||(r.value.towerResult={}),!e){w.warn("çˆ¬å¡”æˆ˜æ–—å¼€å§‹å“åº”ä¸ºç©º");return}});X(["fight_starttower","fight_starttowerresp"],t=>{var T,b,F,Q;w.verbose(`æ”¶åˆ°çˆ¬å¡”æˆ˜æ–—å¼€å§‹äº‹ä»¶: ${t.tokenId}`,t);const{body:e,gameData:r,client:n}=t;if(r.value.towerResult||(r.value.towerResult={}),!e){w.warn("çˆ¬å¡”æˆ˜æ–—å¼€å§‹å“åº”ä¸ºç©º");return}const o=e.battleData;if(!o){w.warn("çˆ¬å¡”æˆ˜æ–—æ•°æ®ä¸ºç©º");return}const i=(T=o.options)==null?void 0:T.towerId,c=(Q=(F=(b=o.result)==null?void 0:b.sponsor)==null?void 0:F.ext)==null?void 0:Q.curHP,d=c>0;if(r.value.towerResult={success:d,curHP:c,towerId:i,timestamp:Date.now()},r.value.lastUpdated=new Date().toISOString(),!d&&i==null)return;const p=i%10,v=Math.floor(i/10);p===0&&setTimeout(()=>{var K,H;const y=r.value.roleInfo,D=(H=(K=y==null?void 0:y.role)==null?void 0:K.tower)==null?void 0:H.reward;D&&!D[v]&&(r.value.towerResult.autoReward=!0,r.value.towerResult.rewardFloor=v,n==null||n.send("tower_claimreward",{rewardId:v}))},1500),setTimeout(()=>{try{n==null||n.send("role_getroleinfo",{})}catch{}},1e3)});X(["tower_claimreward","tower_claimrewardresp"],t=>{const{body:e,gameData:r,client:n}=t;if(!e){w.warn("çˆ¬å¡”æˆ˜æ–—å¼€å§‹å“åº”ä¸ºç©º");return}setTimeout(()=>{n==null||n.send("role_getroleinfo",{})},500)});const ze=(t,e)=>e.some(r=>t instanceof r);let mt,gt;function jr(){return mt||(mt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Fr(){return gt||(gt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const et=new WeakMap,Ze=new WeakMap,We=new WeakMap;function Qr(t){const e=new Promise((r,n)=>{const o=()=>{t.removeEventListener("success",i),t.removeEventListener("error",c)},i=()=>{r(le(t.result)),o()},c=()=>{n(t.error),o()};t.addEventListener("success",i),t.addEventListener("error",c)});return We.set(e,t),e}function Kr(t){if(et.has(t))return;const e=new Promise((r,n)=>{const o=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",c),t.removeEventListener("abort",c)},i=()=>{r(),o()},c=()=>{n(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",i),t.addEventListener("error",c),t.addEventListener("abort",c)});et.set(t,e)}let tt={get(t,e,r){if(t instanceof IDBTransaction){if(e==="done")return et.get(t);if(e==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return le(t[e])},set(t,e,r){return t[e]=r,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function Ut(t){tt=t(tt)}function Gr(t){return Fr().includes(t)?function(...e){return t.apply(rt(this),e),le(this.request)}:function(...e){return le(t.apply(rt(this),e))}}function Hr(t){return typeof t=="function"?Gr(t):(t instanceof IDBTransaction&&Kr(t),ze(t,jr())?new Proxy(t,tt):t)}function le(t){if(t instanceof IDBRequest)return Qr(t);if(Ze.has(t))return Ze.get(t);const e=Hr(t);return e!==t&&(Ze.set(t,e),We.set(e,t)),e}const rt=t=>We.get(t);function Xr(t,e,{blocked:r,upgrade:n,blocking:o,terminated:i}={}){const c=indexedDB.open(t,e),d=le(c);return n&&c.addEventListener("upgradeneeded",p=>{n(le(c.result),p.oldVersion,p.newVersion,le(c.transaction),p)}),r&&c.addEventListener("blocked",p=>r(p.oldVersion,p.newVersion,p)),d.then(p=>{i&&p.addEventListener("close",()=>i()),o&&p.addEventListener("versionchange",v=>o(v.oldVersion,v.newVersion,v))}).catch(()=>{}),d}const Jr=["get","getKey","getAll","getAllKeys","count"],Zr=["put","add","delete","clear"],Ye=new Map;function pt(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(Ye.get(e))return Ye.get(e);const r=e.replace(/FromIndex$/,""),n=e!==r,o=Zr.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!(o||Jr.includes(r)))return;const i=async function(c,...d){const p=this.transaction(c,o?"readwrite":"readonly");let v=p.store;return n&&(v=v.index(d.shift())),(await Promise.all([v[r](...d),o&&p.done]))[0]};return Ye.set(e,i),i}Ut(t=>({...t,get:(e,r,n)=>pt(e,r)||t.get(e,r,n),has:(e,r)=>!!pt(e,r)||t.has(e,r)}));const Yr=["continue","continuePrimaryKey","advance"],wt={},nt=new WeakMap,xt=new WeakMap,zr={get(t,e){if(!Yr.includes(e))return t[e];let r=wt[e];return r||(r=wt[e]=function(...n){nt.set(this,xt.get(this)[e](...n))}),r}};async function*en(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const r=new Proxy(e,zr);for(xt.set(r,e),We.set(r,rt(e));e;)yield r,e=await(nt.get(r)||e.continue()),nt.delete(r)}function _t(t,e){return e===Symbol.asyncIterator&&ze(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&ze(t,[IDBIndex,IDBObjectStore])}Ut(t=>({...t,get(e,r,n){return _t(e,r)?en:t.get(e,r,n)},has(e,r){return _t(e,r)||t.has(e,r)}}));function tn(t={}){const{dbName:e="xyzw",version:r=1,storeName:n="tokens"}=t,o=W(!1),i=W(null),c=W(null),d=async()=>{try{i.value=null;const y=await Xr(e,r,{upgrade(D){D.objectStoreNames.contains(n)||(D.createObjectStore(n,{keyPath:"id"}).createIndex("by-created","createdAt"),console.log(`âœ… IndexedDB å­˜å‚¨ç©ºé—´ "${n}" åˆ›å»ºæˆåŠŸ`))},blocked(){i.value="æ•°æ®åº“è¢«å…¶ä»–æ ‡ç­¾é¡µé˜»å¡ï¼Œè¯·å…³é—­å…¶ä»–ä½¿ç”¨ç›¸åŒæ•°æ®åº“çš„æ ‡ç­¾é¡µ"},blocking(){i.value="æ•°æ®åº“éœ€è¦å‡çº§ï¼Œè¯·å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µåé‡è¯•"},terminated(){i.value="æ•°æ®åº“è¿æ¥æ„å¤–ç»ˆæ­¢"}});c.value=y,o.value=!0,console.log(`âœ… IndexedDB "${e}" åˆå§‹åŒ–æˆåŠŸ`)}catch(y){const D=y instanceof Error?y.message:"æœªçŸ¥é”™è¯¯";i.value=`åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥: ${D}`,console.error("âŒ IndexedDB åˆå§‹åŒ–é”™è¯¯:",y)}},p=async(y,D,K)=>{if(!c.value)return i.value="æ•°æ®åº“æœªåˆå§‹åŒ–",!1;try{const H={id:y,data:D,metadata:K,createdAt:new Date,updatedAt:new Date};return await c.value.put(n,H),console.log(`âœ… ArrayBuffer å­˜å‚¨æˆåŠŸï¼Œé”®: ${y}, å¤§å°: ${D.byteLength} å­—èŠ‚`),!0}catch(H){const z=H instanceof Error?H.message:"æœªçŸ¥é”™è¯¯";return i.value=`å­˜å‚¨æ•°æ®å¤±è´¥: ${z}`,console.error("âŒ å­˜å‚¨ ArrayBuffer é”™è¯¯:",H),!1}},v=async y=>{if(!c.value)return i.value="æ•°æ®åº“æœªåˆå§‹åŒ–",null;try{const D=await c.value.get(n,y);return D?(console.log(`âœ… ArrayBuffer è¯»å–æˆåŠŸï¼Œé”®: ${y}, å¤§å°: ${D.data.byteLength} å­—èŠ‚`),D.data):(console.warn(`âš ï¸ æœªæ‰¾åˆ°é”®ä¸º "${y}" çš„æ•°æ®`),null)}catch(D){const K=D instanceof Error?D.message:"æœªçŸ¥é”™è¯¯";return i.value=`è¯»å–æ•°æ®å¤±è´¥: ${K}`,console.error("âŒ è¯»å– ArrayBuffer é”™è¯¯:",D),null}},T=async()=>{if(!c.value)return i.value="æ•°æ®åº“æœªåˆå§‹åŒ–",[];try{return await c.value.getAllKeys(n)}catch(y){const D=y instanceof Error?y.message:"æœªçŸ¥é”™è¯¯";return i.value=`è·å–é”®åˆ—è¡¨å¤±è´¥: ${D}`,console.error("âŒ è·å–é”®åˆ—è¡¨é”™è¯¯:",y),[]}},b=async y=>{if(!c.value)return i.value="æ•°æ®åº“æœªåˆå§‹åŒ–",!1;try{return await c.value.delete(n,y),console.log(`âœ… ArrayBuffer åˆ é™¤æˆåŠŸï¼Œé”®: ${y}`),!0}catch(D){const K=D instanceof Error?D.message:"æœªçŸ¥é”™è¯¯";return i.value=`åˆ é™¤æ•°æ®å¤±è´¥: ${K}`,console.error("âŒ åˆ é™¤ ArrayBuffer é”™è¯¯:",D),!1}},F=async()=>{if(!c.value)return i.value="æ•°æ®åº“æœªåˆå§‹åŒ–",!1;try{return await c.value.clear(n),console.log("âœ… æ‰€æœ‰ ArrayBuffer æ•°æ®å·²æ¸…ç©º"),!0}catch(y){const D=y instanceof Error?y.message:"æœªçŸ¥é”™è¯¯";return i.value=`æ¸…ç©ºæ•°æ®å¤±è´¥: ${D}`,console.error("âŒ æ¸…ç©ºæ•°æ®é”™è¯¯:",y),!1}},Q=async()=>{if(!c.value)return{totalSize:0,keyCount:0};try{const y=await c.value.getAll(n),D=y.reduce((H,z)=>H+z.data.byteLength,0),K=y.length;return{totalSize:D,keyCount:K}}catch(y){return console.error("âŒ è·å–å­˜å‚¨ä¿¡æ¯é”™è¯¯:",y),{totalSize:0,keyCount:0}}};return d(),{isReady:o,error:i,storeArrayBuffer:p,getArrayBuffer:v,getAllKeys:T,deleteArrayBuffer:b,clearAll:F,getStorageInfo:Q}}const rn=async t=>{const e=await lr.post("https://xxz-xyzw.hortorgames.com/login/authuser",t,{params:{_seq:1},headers:{"Content-Type":"application/octet-stream",referrerPolicy:"no-referrer"},responseType:"arraybuffer"});console.log("è½¬æ¢Token:",typeof e.data);const r=Ve.parse(e.data);console.log("è§£æç»“æœ:",r);const n=r.getData();console.log("æ•°æ®å†…å®¹:",n);const o=Date.now(),i=o*100+Math.floor(Math.random()*100),c=o+Math.floor(Math.random()*10);return JSON.stringify({...n,sessId:i,connId:c,isRestore:0})},nn=2118920861,sn=797788954,on=1513922175;function an(t){if(t==null)return 0;const e=Number(t);if(Number.isNaN(e))return 0;let r=e|0;return r^=nn,r=(r<<16|r>>>16)>>>0,r^=sn,r^=on,r>>>0}const{getArrayBuffer:vt}=tn(),R=ve("gameTokens",[]),cn=$e(()=>R.value.length>0),ae=ve("selectedTokenId",""),De=$e(()=>{var t;return(t=R.value)==null?void 0:t.find(e=>e.id===ae.value)});ve("selectedRoleInfo",null);const ie=ve("activeConnections",{}),Rt=rr("tokens",()=>{const t=W({}),e=W({}),r=W([]),n=W(0),o=W(10),i=W(500),c=W({}),d=W({}),p=W(0),v=W(0),T=W(!1),b=W(!1),F=$e(()=>[...r.value]),Q=s=>{const a=c.value[s];return a===void 0||a<0?0:(n.value+a)*i.value},y=W({roleInfo:null,legionInfo:null,commonActivityInfo:null,bossTowerInfo:null,evoTowerInfo:null,presetTeam:null,battleVersion:null,studyStatus:{isAnswering:!1,questionCount:0,answeredCount:0,status:"",timestamp:null},lastUpdated:null}),D=$e(()=>y.value.roleInfo),K=(s,a)=>{if(s)try{if(typeof s.get=="function")return s.get(a);if(Object.prototype.hasOwnProperty.call(s,a))return s[a]}catch(u){w.warn("è¯»å–ç»Ÿè®¡æ•°æ®å¤±è´¥:",u)}},H=s=>{var f,g;if(!s)return null;const a=[(f=s==null?void 0:s.role)==null?void 0:f.statistics,s==null?void 0:s.statistics,(g=s==null?void 0:s.role)==null?void 0:g.statisticsTime,s==null?void 0:s.statisticsTime],u=["last:login:time","lastLoginTime","last_login_time"];for(const k of a)if(k)for(const C of u){const P=K(k,C);if(P!=null){const U=Number(P);if(!Number.isNaN(U)&&U>0)return U}}return null},z=(s,a,u)=>{if(!u)return;const f=t.value[s];if(!f||f.status!=="connected")return;const g=H(a);if(!g||f.randomSeedSynced&&f.lastRandomSeedSource===g)return;const k=an(g);try{u.send("system_custom",{key:"randomSeed",value:k}),f.randomSeedSynced=!0,f.lastRandomSeedSource=g,f.lastRandomSeed=k,l.info(`åŒæ­¥ randomSeed [${s}]`,{lastLoginTime:g,randomSeed:k})}catch(C){l.error(`å‘é€ randomSeed å¤±è´¥ [${s}]`,C)}},me=s=>{const a={id:"token_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),name:s.name,token:s.token,wsUrl:s.wsUrl||null,server:s.server||"",remark:s.remark||"",level:s.level||1,profession:s.profession||"",createdAt:new Date().toISOString(),lastUsed:new Date().toISOString(),isActive:!0,sourceUrl:s.sourceUrl||null,importMethod:s.importMethod||"manual"};return R.value.push(a),a},J=(s,a)=>{const u=R.value.findIndex(f=>f.id===s);return u!==-1?(R.value[u]={...R.value[u],...a,updatedAt:new Date().toISOString()},!0):!1},Ae=s=>(R.value=R.value.filter(a=>a.id!==s),t.value[s]&&M(s),ae.value===s&&(ae.value=null),!0),ye=(s,a=!1)=>{const u=R.value.find(U=>U.id===s);if(!u)return null;const f=ae.value===s,g=t.value[s],k=(g==null?void 0:g.status)==="connected",C=(g==null?void 0:g.status)==="connecting";return qe.debug(`é€‰æ‹©Token: ${s}`,{isAlreadySelected:f,isConnected:k,isConnecting:C,forceReconnect:a}),ae.value=s,J(s,{lastUsed:new Date().toISOString()}),k||(a||!f||!g||g.status==="disconnected"||g.status==="error"?(f&&!a?l.info(`Tokenå·²é€‰ä¸­ä½†æ— è¿æ¥ï¼Œåˆ›å»ºæ–°è¿æ¥: ${s}`):f?a&&l.info(`å¼ºåˆ¶é‡è¿Token: ${s}`):l.info(`åˆ‡æ¢åˆ°æ–°Tokenï¼Œåˆ›å»ºè¿æ¥: ${s}`),S(s,u.token,u.wsUrl)):k?l.debug(`Tokenå·²è¿æ¥ï¼Œè·³è¿‡è¿æ¥åˆ›å»º: ${s}`):C?l.debug(`Tokenè¿æ¥ä¸­ï¼Œè·³è¿‡è¿æ¥åˆ›å»º: ${s}`):l.debug(`Tokenå·²é€‰ä¸­ä¸”æœ‰è¿æ¥ï¼Œè·³è¿‡è¿æ¥åˆ›å»º: ${s}`)),u},Be=async(s,a,u)=>{var f;try{if(!a){w.warn(`æ¶ˆæ¯å¤„ç†è·³è¿‡ [${s}]: æ— æ•ˆæ¶ˆæ¯`);return}if(a.error){const C=String(a.error).toLowerCase();if(w.warn(`æ¶ˆæ¯å¤„ç†è·³è¿‡ [${s}]:`,a.error),C.includes("token")&&C.includes("expired")){const P=t.value[s];P&&(P.status="error",P.lastError={timestamp:new Date().toISOString(),error:"token expired"});const U=R.value.find(N=>N.id===s);if(console.log(U),U)if(U.importMethod==="url"&&U.sourceUrl)try{const N=await fetch(U.sourceUrl);if(N.ok){const x=await N.json();x.token&&(J(s,{...U,token:x.token}),console.log("ä»URLè·å–tokenæˆåŠŸ:",U.name))}}catch(N){console.error("ä»URLè·å–tokenå¤±è´¥:",N)}else{console.log("getArrayBuffer",await vt("å°é±¼"));const N=await vt(U.name);if(console.log("è¯»å–åˆ°çš„ArrayBuffer:",U.name,N),N){const x=await rn(N);J(s,{...U,token:x}),console.log(U)}}l.error(`Token å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°å¯¼å…¥ [${s}]`)}return}const g=(f=a.cmd)==null?void 0:f.toLowerCase(),k=a.getData();g==="role_getroleinforesp"&&z(s,k,u),Wr(g,{tokenId:s,body:k,message:a,client:u,gameData:y}),w.gameMessage(s,g,!!k)}catch(g){w.error(`å¤„ç†æ¶ˆæ¯å¤±è´¥ [${s}]:`,g)}},ee=s=>!(!s||typeof s!="string"||s.trim().length===0||s.trim().length<10),ge=s=>{try{if(!s||typeof s!="string")throw new Error("Tokenå­—ç¬¦ä¸²æ— æ•ˆ");const a=s.replace(/^data:.*base64,/,"").trim();if(a.length===0)throw new Error("Tokenå­—ç¬¦ä¸²ä¸ºç©º");let u;try{u=atob(a)}catch{u=s.trim()}let f;try{f=JSON.parse(u)}catch{f={token:u}}const g=f.token||f.gameToken||u;if(!ee(g))throw new Error(`æå–çš„tokenæ— æ•ˆ: "${g}"`);return{success:!0,data:{...f,actualToken:g}}}catch(a){return{success:!1,error:"è§£æå¤±è´¥ï¼š"+a.message}}},Fe=(s,a,u={})=>{const f=ge(a);if(!f.success)return{success:!1,error:f.error,message:`Token "${s}" å¯¼å…¥å¤±è´¥: ${f.error}`};const g={name:s,token:f.data.actualToken,...u,...f.data};try{const k=me(g),C=f.data.actualToken,P=C.length>20?`${C.substring(0,10)}...${C.substring(C.length-6)}`:C;return{success:!0,token:k,tokenName:s,message:`Token "${s}" å¯¼å…¥æˆåŠŸ`,details:`å®é™…Token: ${P}`}}catch(k){return{success:!1,error:k.message,message:`Token "${s}" æ·»åŠ å¤±è´¥: ${k.message}`}}},te="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),L=async(s,a="connect")=>{const u=`${s}_${a}`,f=e.value;if(f[u]){l.debug(`ç­‰å¾…è¿æ¥é”é‡Šæ”¾: ${s} (${a})`);let g=0;for(;f[u]&&g<100;)await new Promise(k=>setTimeout(k,100)),g++;if(f[u])return l.warn(`è¿æ¥é”ç­‰å¾…è¶…æ—¶: ${s} (${a})`),!1}return f[u]={tokenId:s,operation:a,timestamp:Date.now(),sessionId:te},l.connectionLock(s,a,!0),!0},_=(s,a="connect")=>{const u=`${s}_${a}`;e.value[u]&&(delete e.value[u],l.connectionLock(s,a,!1))},m=(s,a,u=te)=>{let f=ve(`ws_connection_${s}`,{action:a,sessionId:u,timestamp:Date.now(),url:window.location.href});ie.value&&(ie.value[s]=f.value)},h=s=>{const a=`ws_connection_${s}`;try{const u=localStorage.getItem(a);if(u){const f=JSON.parse(u),g=Date.now()-f.timestamp<3e4,k=f.sessionId!==te;if(g&&k&&(f.action==="connecting"||f.action==="connected"))return l.debug(`æ£€æµ‹åˆ°å…¶ä»–æ ‡ç­¾é¡µçš„æ´»è·ƒè¿æ¥: ${s}`),f}}catch(u){l.warn("æ£€æŸ¥è·¨æ ‡ç­¾é¡µè¿æ¥çŠ¶æ€å¤±è´¥:",u)}return null},B=async(s,a,u=null)=>{if(l.info(`å¼€å§‹åˆ›å»ºè¿æ¥: ${s}`),!await L(s,"connect"))return l.error(`æ— æ³•è·å–è¿æ¥é”: ${s}`),null;try{if(h(s))return l.debug(`è·³è¿‡åˆ›å»ºï¼Œå…¶ä»–æ ‡ç­¾é¡µå·²æœ‰è¿æ¥: ${s}`),_(s,"connect"),null;m(s,"connecting"),t.value[s]&&(l.debug(`ä¼˜é›…å…³é—­ç°æœ‰è¿æ¥: ${s}`),await A(s));const k=ge(a);let C;if(k.success)C=k.data.actualToken;else if(ee(a))C=a;else throw new Error(`Tokenæ— æ•ˆ: ${k.error}`);const P=`wss://xxz-xyzw.hortorgames.com/agent?p=${encodeURIComponent(C)}&e=x&lang=chinese`,U=u||P;l.debug(`Token: ${C.substring(0,10)}...${C.slice(-4)}`);const N=new Lr({url:U,utils:Ve,heartbeatMs:5e3});return t.value[s]={client:N,status:"connecting",tokenId:s,wsUrl:U,actualToken:C,sessionId:te,connectedAt:null,lastMessage:null,lastError:null,reconnectAttempts:0,randomSeedSynced:!1,lastRandomSeedSource:null,lastRandomSeed:null},N.onConnect=()=>{l.wsConnect(s),t.value[s]&&(t.value[s].status="connected",t.value[s].connectedAt=new Date().toISOString(),t.value[s].reconnectAttempts=0,t.value[s].randomSeedSynced=!1,t.value[s].lastRandomSeedSource=null,t.value[s].lastRandomSeed=null),m(s,"connected"),_(s,"connect"),localStorage.removeItem("xyzw_chat_msg_list");try{N.send("role_getroleinfo")}catch(x){l.warn(`åˆå§‹åŒ–è§’è‰²ä¿¡æ¯è¯·æ±‚å¤±è´¥ [${s}]`,x)}},N.onDisconnect=x=>{const Ke=x.code===1006?"å¼‚å¸¸æ–­å¼€":x.reason||"";l.wsDisconnect(s,Ke),t.value[s]&&(t.value[s].status="disconnected",t.value[s].randomSeedSynced=!1),m(s,"disconnected")},N.onError=x=>{l.wsError(s,x),t.value[s]&&(t.value[s].status="error",t.value[s].lastError={timestamp:new Date().toISOString(),error:x.toString(),url:U}),_(s,"connect")},N.setMessageListener(x=>{const Ke=(x==null?void 0:x.cmd)||"unknown";l.wsMessage(s,Ke,!0),t.value[s]&&(t.value[s].lastMessage={timestamp:new Date().toISOString(),data:x,cmd:x==null?void 0:x.cmd},Be(s,x,N))}),N.init(),l.verbose(`WebSocketå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ: ${s}`),N}catch(g){return l.error(`åˆ›å»ºè¿æ¥å¤±è´¥ [${s}]:`,g),m(s,"disconnected"),_(s,"connect"),null}},A=async s=>{if(!await L(s,"disconnect")){l.warn(`æ— æ³•è·å–æ–­å¼€è¿æ¥é”: ${s}`);return}try{const u=t.value[s];u&&u.client&&(l.debug(`å¼€å§‹ä¼˜é›…å…³é—­è¿æ¥: ${s}`),u.status="disconnecting",m(s,"disconnecting"),u.client.disconnect(),await new Promise(f=>{const g=()=>{u.client.connected?setTimeout(g,100):f()};setTimeout(f,5e3),g()}),delete t.value[s],m(s,"disconnected"),l.info(`è¿æ¥å·²ä¼˜é›…å…³é—­: ${s}`))}catch(u){l.error(`å…³é—­è¿æ¥å¤±è´¥ [${s}]:`,u)}finally{_(s,"disconnect")}},S=async(s,a,u=null)=>{if(n.value<o.value){n.value++;try{return await B(s,a,u)}catch(f){return l.error(`åˆ›å»ºè¿æ¥å¤±è´¥ [${s}]:`,f),null}finally{n.value--,setTimeout(Ce,i.value)}}else return ct(s),null},E=async s=>{const a=R.value.find(u=>u.id===s);return a?S(s,a.token,a.wsUrl):(l.error(`connectWebSocket: Token not found [${s}]`),null)},$=async s=>A(s),M=s=>{A(s).catch(a=>{l.error(`å…³é—­è¿æ¥å¼‚æ­¥æ“ä½œå¤±è´¥ [${s}]:`,a)})},q=s=>{var a;return((a=t.value[s])==null?void 0:a.status)||"disconnected"},V=s=>{var a;return((a=t.value[s])==null?void 0:a.client)||null},O=s=>{if(De.value){const a=t.value[De.value.id];a&&a.client&&a.client.setMessageListener(s)}},oe=s=>{if(De.value){const a=t.value[De.value.id];a&&a.client&&a.client.setShowMsg(s)}},G=(s,a,u={},f={})=>{const g=t.value[s];if(!g||g.status!=="connected")return l.error(`WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ [${s}]`),!1;try{const k=g.client;return k?(k.send(a,u,f),l.wsMessage(s,a,!1),!0):(l.error(`WebSocketå®¢æˆ·ç«¯ä¸å­˜åœ¨ [${s}]`),!1)}catch(k){return l.error(`å‘é€å¤±è´¥ [${s}] ${a}:`,k.message),!1}},Z=async(s,a,u={},f=5e3)=>{const g=t.value[s];if(!g||g.status!=="connected")return Promise.reject(new Error(`WebSocketæœªè¿æ¥ [${s}]`));const k=g.client;if(!k)return Promise.reject(new Error(`WebSocketå®¢æˆ·ç«¯ä¸å­˜åœ¨ [${s}]`));if(["fight_startareaarena","fight_startpvp","fight_starttower","fight_startboss","fight_startlegionboss","fight_startdungeon"].includes(a)){const P=y.value.battleVersion;u={battleVersion:P,...u},l.info(`âš”ï¸ [æˆ˜æ–—å‘½ä»¤] æ³¨å…¥ battleVersion: ${P} [${a}]`)}try{const P=await k.sendWithPromise(a,u,f);return a==="fight_starttower"&&l.info(`ğŸ—¼ [å’¸å°†å¡”] æ”¶åˆ°çˆ¬å¡”å“åº” [${s}]:`,P),P}catch(P){return a==="fight_starttower"&&l.error(`ğŸ—¼ [å’¸å°†å¡”] çˆ¬å¡”è¯·æ±‚å¤±è´¥ [${s}]:`,P.message),Promise.reject(P)}},Ie=s=>G(s,"heart_beat"),re=async(s,a={},u=0)=>{try{const g=await Z(s,"role_getroleinfo",a,15e3);return g&&(y.value.roleInfo=g,y.value.lastUpdated=new Date().toISOString(),w.verbose("è§’è‰²ä¿¡æ¯å·²é€šè¿‡ Promise æ›´æ–°")),g}catch(f){if(w.error(`è·å–è§’è‰²ä¿¡æ¯å¤±è´¥ [${s}]:`,f.message),u<2)return w.info(`æ­£åœ¨é‡è¯•è·å–è§’è‰²ä¿¡æ¯ [${s}]ï¼Œé‡è¯•æ¬¡æ•°: ${u+1}`),await new Promise(g=>setTimeout(g,1e3)),re(s,a,u+1);throw f}},Le=(s,a={})=>Z(s,"system_getdatabundlever",a),be=s=>Z(s,"system_signinreward"),Nt=(s,a=0)=>Z(s,"task_claimdailyreward",{rewardId:a}),Vt=(s,a={})=>Z(s,"presetteam_getinfo",a),Wt=(s,a,u={},f={})=>f.usePromise?Z(s,a,u,f.timeout):G(s,a,u,f),jt=()=>{try{const s=y.value.roleInfo;if(!s||!s.role)return w.warn("è§’è‰²ä¿¡æ¯ä¸å­˜åœ¨"),null;const a=s.role.tower;return a?a.level||a.currentLevel||a.floor||a.stage:(w.warn("å¡”ä¿¡æ¯ä¸å­˜åœ¨"),null)}catch(s){return w.error("è·å–å¡”å±‚æ•°å¤±è´¥:",s),null}},Ft=()=>{try{const s=y.value.roleInfo;return!s||!s.role?null:s.role.tower||null}catch(s){return w.error("è·å–å¡”ä¿¡æ¯å¤±è´¥:",s),null}},Qt=()=>({tokens:R.value,exportedAt:new Date().toISOString(),version:"2.0"}),Kt=s=>{try{return s.tokens&&Array.isArray(s.tokens)?(R.value=s.tokens,{success:!0,message:`æˆåŠŸå¯¼å…¥ ${s.tokens.length} ä¸ªToken`}):{success:!1,message:"å¯¼å…¥æ•°æ®æ ¼å¼é”™è¯¯"}}catch(a){return{success:!1,message:"å¯¼å…¥å¤±è´¥ï¼š"+a.message}}},Gt=()=>{Object.keys(t.value).forEach(s=>{M(s)}),R.value=[],ae.value=null},at=()=>{const s=new Date,a=new Date(s.getTime()-24*60*60*1e3),u=R.value.filter(g=>g.importMethod==="url"||g.importMethod==="bin"||g.upgradedToPermanent?!0:new Date(g.lastUsed||g.createdAt)>a),f=R.value.length-u.length;return R.value=u,f},Ht=s=>{const a=R.value.find(u=>u.id===s);return a&&!a.upgradedToPermanent&&a.importMethod!=="url"&&a.importMethod!=="bin"?(J(s,{upgradedToPermanent:!0,upgradedAt:new Date().toISOString()}),!0):!1},Xt=s=>{const a=Object.values(t.value).filter(u=>u.tokenId===s&&(u.status==="connecting"||u.status==="connected"));if(a.length>1){l.warn(`æ£€æµ‹åˆ°é‡å¤è¿æ¥: ${s}, è¿æ¥æ•°: ${a.length}`);const u=a.sort((f,g)=>new Date(g.connectedAt||0)-new Date(f.connectedAt||0));for(let f=1;f<u.length;f++){const g=u[f];l.debug(`å…³é—­é‡å¤è¿æ¥: ${s}`),A(g.tokenId)}return!1}return!0},Oe={startMonitoring:()=>{setInterval(()=>{const s=Date.now();console.log("wsè¿æ¥ç›‘æ§è¿è¡Œä¸­...",t.value),console.log("coè¿æ¥ç›‘æ§è¿è¡Œä¸­...",e.value),console.log("acè¿æ¥ç›‘æ§è¿è¡Œä¸­...",ie.value),Object.entries(t.value).forEach(([a,u])=>{var g;const f=((g=u.lastMessage)==null?void 0:g.timestamp)||u.connectedAt;f&&s-new Date(f).getTime()>3e4&&u.status==="connected"&&(l.warn(`æ£€æµ‹åˆ°è¿æ¥å¯èƒ½å·²æ–­å¼€: ${a}`),u.client&&u.client.sendHeartbeat())}),Object.entries(e.value).forEach(([a,u])=>{s-u.timestamp>6e5&&(delete e.value[a],l.debug(`æ¸…ç†è¿‡æœŸè¿æ¥é”: ${a}`))}),Object.entries(ie.value).forEach(([a,u])=>{s-u.timestamp>3e5&&(l.debug(`æ¸…ç†è¿‡æœŸè·¨æ ‡ç­¾é¡µçŠ¶æ€: ${a}`),delete ie.value[a],localStorage.removeItem(`ws_connection_${a}`))})},1e4)},getStats:()=>{const s=[],a={totalConnections:Object.keys(t.value).length,connectedCount:0,connectingCount:0,disconnectedCount:0,errorCount:0,duplicateTokens:s,activeLocks:Object.keys(e.value).length,crossTabStates:Object.keys(ie.value).length},u=new Map;return Object.values(t.value).forEach(f=>{a[f.status+"Count"]++;const g=u.get(f.tokenId)||0;u.set(f.tokenId,g+1),g>0&&a.duplicateTokens.push(f.tokenId)}),a},forceCleanup:async()=>{l.info("å¼€å§‹å¼ºåˆ¶æ¸…ç†æ‰€æœ‰è¿æ¥...");const s=Object.keys(t.value).map(a=>A(a));await Promise.all(s),Object.keys(localStorage).forEach(a=>{a.startsWith("ws_connection_")&&localStorage.removeItem(a)}),l.info("å¼ºåˆ¶æ¸…ç†å®Œæˆ")}},Jt=()=>{window.addEventListener("storage",s=>{var a;if((a=s.key)!=null&&a.startsWith("ws_connection_")){const u=s.key.replace("ws_connection_","");if(l.debug(`æ£€æµ‹åˆ°è·¨æ ‡ç­¾é¡µè¿æ¥çŠ¶æ€å˜åŒ–: ${u}`,s.newValue),s.newValue)try{const f=JSON.parse(s.newValue),g=t.value[u];f.action==="connected"&&f.sessionId!==te&&(g==null?void 0:g.status)==="connected"&&(l.info(`æ£€æµ‹åˆ°å…¶ä»–æ ‡ç­¾é¡µå·²è¿æ¥åŒä¸€tokenï¼Œå…³é—­æœ¬åœ°è¿æ¥: ${u}`),A(u))}catch(f){l.warn("è§£æè·¨æ ‡ç­¾é¡µçŠ¶æ€å¤±è´¥:",f)}}})},Ce=async()=>{if(n.value>=o.value||r.value.length===0)return;const s=r.value.shift();if(s){Me();try{const a=R.value.find(u=>u.id===s);if(!a){l.error(`Token not found: ${s}`);return}n.value++,l.info(`å¼€å§‹å¤„ç†é˜Ÿåˆ—ä¸­çš„è¿æ¥: ${s}ï¼Œå½“å‰æ´»è·ƒè¿æ¥æ•°: ${n.value}`),await B(s,a.token,a.wsUrl)}catch(a){l.error(`å¤„ç†é˜Ÿåˆ—è¿æ¥å¤±è´¥: ${s}`,a)}finally{n.value--,l.info(`é˜Ÿåˆ—è¿æ¥å¤„ç†å®Œæˆ: ${s}ï¼Œå½“å‰æ´»è·ƒè¿æ¥æ•°: ${n.value}`),setTimeout(Ce,i.value)}}},Me=()=>{const s={};r.value.forEach((a,u)=>{s[a]=u}),c.value=s},ct=s=>{if(r.value.includes(s)){l.debug(`Token already in queue: ${s}`);return}const a=t.value[s];if(a&&(a.status==="connected"||a.status==="connecting")){l.debug(`Token already connected or connecting: ${s}`);return}r.value.push(s),d.value[s]=Date.now(),Me();const u=c.value[s],f=Q(s);l.info(`Token added to connection queue: ${s}, position: ${u+1}, estimated wait: ${f}ms`),setTimeout(Ce,0)},Zt=s=>{const a=r.value.indexOf(s);a>-1&&(r.value.splice(a,1),delete d.value[s],Me(),l.info(`Token removed from connection queue: ${s}`))},Yt=()=>{p.value++,T.value=!0,l.info(`ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰è¿è¡Œä»»åŠ¡æ•°: ${p.value}`)},zt=()=>{p.value=Math.max(0,p.value-1),l.info(`ä»»åŠ¡ç»“æŸï¼Œå½“å‰è¿è¡Œä»»åŠ¡æ•°: ${p.value}`),p.value===0&&v.value===0&&(T.value=!1,l.info("æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ"),b.value&&(Pe(),b.value=!1))},er=()=>{v.value++,T.value=!0,l.info(`å®šæ—¶ä»»åŠ¡æ’é˜Ÿï¼Œå½“å‰æ’é˜Ÿæ•°: ${v.value}`)},tr=()=>{v.value=Math.max(0,v.value-1),l.info(`å®šæ—¶ä»»åŠ¡å®Œæˆï¼Œå½“å‰æ’é˜Ÿæ•°: ${v.value}`),p.value===0&&v.value===0&&(T.value=!1,l.info("æ‰€æœ‰å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆ"),b.value&&(Pe(),b.value=!1))},Pe=async()=>{l.info("å¼€å§‹å…³é—­æ‰€æœ‰WebSocketè¿æ¥"),r.value=[],Me();const s=Object.keys(t.value);l.info(`éœ€è¦å…³é—­çš„è¿æ¥æ•°: ${s.length}`);for(const a of s)try{await A(a),l.info(`è¿æ¥å·²å…³é—­: ${a}`)}catch(u){l.error(`å…³é—­è¿æ¥å¤±è´¥: ${a}`,u)}l.info("æ‰€æœ‰WebSocketè¿æ¥å…³é—­å®Œæˆ")};return{gameTokens:R,selectedTokenId:ae,wsConnections:t,gameData:y,hasTokens:cn,selectedToken:De,selectedTokenRoleInfo:D,connectionQueue:r,activeConnectionCount:n,maxConcurrentConnections:o,queuedTokens:F,addToken:me,updateToken:J,removeToken:Ae,selectToken:ye,parseBase64Token:ge,importBase64Token:Fe,createWebSocketConnection:S,connectWebSocket:E,disconnectWebSocket:$,closeWebSocketConnection:M,getWebSocketStatus:q,getWebSocketClient:V,sendMessage:G,sendMessageWithPromise:Z,setMessageListener:O,setShowMsg:oe,sendHeartbeat:Ie,sendGetRoleInfo:re,sendGetDataBundleVersion:Le,sendSignIn:be,sendClaimDailyReward:Nt,sendGetTeamInfo:Vt,sendGameMessage:Wt,getEstimatedWaitTime:Q,enqueueConnection:ct,dequeueConnection:Zt,processConnectionQueue:Ce,startTask:Yt,finishTask:zt,scheduleTask:er,finishScheduledTask:tr,closeAllConnections:Pe,closeAllConnectionsAfterTasks:()=>{b.value=!0,l.info("å·²æ ‡è®°ï¼šæ‰€æœ‰ä»»åŠ¡å®Œæˆåå…³é—­è¿æ¥"),T.value||(Pe(),b.value=!1)},runningTasksCount:p,scheduledTasksQueue:v,isTasksRunning:T,exportTokens:Qt,importTokens:Kt,clearAllTokens:Gt,cleanExpiredTokens:at,upgradeTokenToPermanent:Ht,initTokenStore:()=>{at(),Oe.startMonitoring(),Jt(),qe.info("Token Store åˆå§‹åŒ–å®Œæˆï¼Œè¿æ¥ç›‘æ§å·²å¯åŠ¨")},getCurrentTowerLevel:jt,getTowerInfo:Ft,setBattleVersion:s=>{y.value.battleVersion=s,y.value.lastUpdated=new Date().toISOString()},getBattleVersion:()=>y.value.battleVersion,validateToken:ee,debugToken:s=>{console.log("ğŸ” Tokenè°ƒè¯•ä¿¡æ¯:"),console.log("åŸå§‹Token:",s);const a=ge(s);return console.log("è§£æç»“æœ:",a),a.success&&(console.log("å®é™…Token:",a.data.actualToken),console.log("Tokenæœ‰æ•ˆæ€§:",ee(a.data.actualToken))),a},validateConnectionUniqueness:Xt,connectionMonitor:Oe,currentSessionId:()=>te,devTools:{getConnectionStats:()=>Oe.getStats(),forceCleanup:()=>Oe.forceCleanup(),showConnectionLocks:()=>Object.keys(e.value),showCrossTabStates:()=>Object.keys(ie.value),testDuplicateConnection:s=>{const a=R.value.find(u=>u.id===s);a&&S(s+"_test",a.token)}}}}),un=pr??[],ln=[{path:"/",name:"Home",component:()=>I(()=>import("./Home-D_-7XTmr.js"),__vite__mapDeps([31,26,1,13,12,2,20,17,32,4,33,5,3,34])),meta:{title:"é¦–é¡µ",requiresToken:!1}},{path:"/tokens",name:"TokenImport",component:()=>I(()=>import("./index-BQ_7dm-_.js"),__vite__mapDeps([45,46,1,2,47,26,48,3,49,40,5,50,51,52,53,54,22,33,41,14,29,25,55])),meta:{title:"Tokenç®¡ç†",requiresToken:!1},props:t=>({token:t.query.token,name:t.query.name,server:t.query.server,wsUrl:t.query.wsUrl,api:t.query.api,auto:t.query.auto==="true"})},{name:"DefaultLayout",path:"/admin",component:()=>I(()=>import("./DefaultLayout-DTMdajZ2.js"),__vite__mapDeps([56,26,46,1,2,47,33,17,20,4,15,3,5,57])),children:[{path:"dashboard",name:"Dashboard",component:()=>I(()=>import("./Dashboard-DHUptxYs.js"),__vite__mapDeps([19,1,2,20,21,10,17,22,4,3,5,23])),meta:{title:"æ§åˆ¶å°",requiresToken:!0}},{path:"game-features",name:"GameFeatures",component:()=>I(()=>import("./GameFeatures-C0ZYo-ey.js"),__vite__mapDeps([24,2,3,1,14,25,4,21,26,5,27])),meta:{title:"æ¸¸æˆåŠŸèƒ½",requiresToken:!0}},{path:"message-test",name:"MessageTest",component:()=>I(()=>import("./MessageTester-Dk_HE8GA.js"),__vite__mapDeps([58,2,49,1,3,5,59])),meta:{title:"æ¶ˆæ¯æµ‹è¯•",requiresToken:!0}},{path:"profile",name:"Profile",component:()=>I(()=>import("./Profile-CThMevbB.js"),__vite__mapDeps([39,12,1,11,2,3,29,14,40,41,13,5,42])),meta:{title:"ä¸ªäººè®¾ç½®",requiresToken:!0}},{path:"daily-tasks",name:"DailyTasks",component:()=>I(()=>import("./DailyTasks-ltEBlPa3.js"),__vite__mapDeps([9,1,2,4,10,3,11,12,13,14,15,16,17,5,18])),meta:{title:"æ—¥å¸¸ä»»åŠ¡",requiresToken:!0}},{path:"batch-daily-tasks",name:"BatchDailyTasks",component:()=>I(()=>import("./BatchDailyTasks-xsGq_iQa.js"),__vite__mapDeps([0,1,2,3,4,5,6])),meta:{title:"æ‰¹é‡æ—¥å¸¸",requiresToken:!0}}]},{path:"/websocket-test",name:"WebSocketTest",component:()=>I(()=>import("./WebSocketTester-DHtad7hQ.js"),__vite__mapDeps([60,2,3,1,5,61])),meta:{title:"WebSocketæµ‹è¯•",requiresToken:!0}},{path:"/login",redirect:"/tokens"},{path:"/register",redirect:"/tokens"},{path:"/game-roles",redirect:"/tokens"},...un,{path:"/:pathMatch(.*)*",redirect:"/"}],qt=nr({history:sr(),routes:ln,scrollBehavior(t,e,r){return r||{top:0}}});qt.beforeEach((t,e,r)=>{const n=Rt();document.title=t.meta.title?`${t.meta.title} - XYZW æ¸¸æˆç®¡ç†ç³»ç»Ÿ`:"XYZW æ¸¸æˆç®¡ç†ç³»ç»Ÿ",t.meta.requiresToken&&!n.hasTokens?r("/tokens"):t.path==="/"&&n.hasTokens?n.selectedToken?r("/admin/dashboard"):r("/tokens"):r()});const we=W(!1),dn=()=>document.documentElement.classList.contains("dark")||document.documentElement.getAttribute("data-theme")==="dark",Re=()=>{we.value=dn()};function fn(){let t=null;const e=()=>{const v=localStorage.getItem("theme"),T=window.matchMedia("(prefers-color-scheme: dark)").matches;v==="dark"||!v&&T?r():n(),Re()},r=()=>{document.documentElement.classList.add("dark"),document.documentElement.setAttribute("data-theme","dark"),document.body.classList.add("dark"),document.body.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark"),we.value=!0,window.dispatchEvent(new CustomEvent("theme-change",{detail:{isDark:!0}}))},n=()=>{document.documentElement.classList.remove("dark"),document.documentElement.removeAttribute("data-theme"),document.body.classList.remove("dark"),document.body.removeAttribute("data-theme"),localStorage.setItem("theme","light"),we.value=!1,window.dispatchEvent(new CustomEvent("theme-change",{detail:{isDark:!1}}))},o=()=>{we.value?n():r()},i=()=>{window.matchMedia("(prefers-color-scheme: dark)").addListener(()=>{localStorage.getItem("theme")||e()})},c=()=>{typeof window<"u"&&(t=new MutationObserver(()=>{Re()}),t.observe(document.documentElement,{attributes:!0,attributeFilter:["class","data-theme"]}),t.observe(document.body,{attributes:!0,attributeFilter:["class","data-theme"]}))},d=()=>{t&&(t.disconnect(),t=null)},p=()=>we.value?"dark":"light";return yt(()=>{c(),Re()}),bt(()=>{d()}),{isDark:we,initTheme:e,toggleTheme:o,setDarkTheme:r,setLightTheme:n,setupSystemThemeListener:i,getCurrentTheme:p,updateReactiveState:Re}}const hn={id:"app"},mn={__name:"App",setup(t){const{isDark:e,initTheme:r,setupSystemThemeListener:n,updateReactiveState:o}=fn(),i=$e(()=>e.value?fr:null),c=()=>{o(),setTimeout(()=>{o()},50)};return yt(()=>{r(),n(),window.addEventListener("theme-change",c),o()}),bt(()=>{window.removeEventListener("theme-change",c)}),(d,p)=>{const v=pe("router-view"),T=pe("n-dialog-provider"),b=pe("n-notification-provider"),F=pe("n-loading-bar-provider"),Q=pe("n-message-provider"),y=pe("n-config-provider");return ir(),or(y,{theme:i.value},{default:Te(()=>[ke(Q,null,{default:Te(()=>[ke(F,null,{default:Te(()=>[ke(b,null,{default:Te(()=>[ke(T,null,{default:Te(()=>[ar("div",hn,[ke(v)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["theme"])}}},je=cr(mn);je.use(ur());je.use(qt);je.use(hr);const gn=()=>{const t=localStorage.getItem("theme")||"auto";t==="dark"?document.documentElement.setAttribute("data-theme","dark"):t==="light"?document.documentElement.removeAttribute("data-theme"):(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",r=>{(localStorage.getItem("theme")||"auto")==="auto"&&(r.matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"))}))};gn();je.mount("#app");export{_e as $,I as _,De as a,fn as b,tn as c,Ve as d,kn as e,Sn as g,Dn as p,ae as s,rn as t,Rt as u};
